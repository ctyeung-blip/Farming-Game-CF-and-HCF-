<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å°è¾²å¤«è€•ç¨®æ¨‚ (æŒ‘æˆ°ç‰ˆ) ğŸšœ</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            overscroll-behavior: none; /* é˜²æ­¢ "pull-to-refresh" */
        }
        /* è€•åœ°å®¹å™¨ */
        #farm-grid-container {
            display: grid;
            border: 4px solid #8B4513; /* åœŸå£¤é¡è‰² */
            background-color: #fcf8e3; /* æ·ºé»ƒè‰²ä»£è¡¨æ³¥åœŸ */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            overflow: hidden; /* é˜²æ­¢ç£šå¡Šæº¢å‡º */
            position: relative; /* ç”¨æ–¼å®šä½çµæœæ–‡å­— */
            width: 100%; 
            max-width: 450px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            margin: 0 auto; /* å±…ä¸­ */
            aspect-ratio: var(--aspect-ratio-val, 1 / 1);
        }

        /* é‹ªç£šæ•ˆæœ (å…±åŒæ¨£å¼) */
        .tile-base {
            position: absolute;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            animation: tile-fade-in 0.3s ease-out forwards;
            transform-origin: center;
            line-height: 1;
            width: calc(var(--tile-width, 10%) - 1px);
            height: calc(var(--tile-height, 10%) - 1px);
            left: calc(var(--tile-x, 0%) + 1px);
            top: calc(var(--tile-y, 0%) + 1px);
        }

        /* é‹ªç£šæ•ˆæœ */
        .plant-tile {
            background-color: #22c55e; /* green-500 */
            border: 1px solid #16a34a; /* darker green */
            opacity: 0.85;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 10;
            color: white;
        }
        .gap-tile {
            background-color: #ef4444; /* red-500 */
            border: 1px dashed white;
            opacity: 0.7;
            z-index: 10;
            color: white;
        }
        
        @keyframes tile-fade-in {
            0% { opacity: 0; transform: scale(0.7); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .gap-tile { opacity: 0.7; }
        .plant-tile { opacity: 0.85; }

        /* å·¥å…·ç®±æŒ‰éˆ• */
        .tool-btn {
            transition: all 0.2s ease;
        }
        .tool-btn.tested {
            background-color: #6b7280;
            color: white;
            opacity: 0.7;
            cursor: not-allowed;
        }
        .tool-btn:disabled {
            background-color: #9ca3af;
            color: #e5e7eb;
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(0.95);
        }

        /* æ„›å¿ƒ (ç”Ÿå‘½å€¼) */
        #lives-display {
            font-size: 1.75rem;
            letter-spacing: 0.2em;
        }
        
        /* å½ˆçª—å‹•ç•« */
        .modal-content {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: scale(0.95);
            opacity: 0;
        }
        .modal-content.show {
            transform: scale(1);
            opacity: 1;
        }

        /* æŒ‘æˆ°è³½é€²åº¦æ¢ */
        #challenge-progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        /* ä¸‹ä¸€é—œæŒ‰éˆ•å‹•ç•« */
        @keyframes pulse-scale {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }
        .animate-pulse-scale {
            animation: pulse-scale 2s infinite;
        }
    </style>
</head>
<body class="bg-yellow-50 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-5xl mx-auto bg-white rounded-2xl shadow-2xl p-6 md:p-8">
        
        <!-- æ¨™é¡Œ -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-yellow-900">å°å°è¾²å¤«è€•ç¨®æ¨‚ ğŸšœ</h1>
            <p class="text-lg text-gray-600 mt-2">å¹«åŠ©è¾²å¤«ä»¥ä¸æµªè²»åœŸåœ°çš„æ–¹æ³•ç¨®è¾²ä½œç‰©</p>
            
            <!-- è¨ˆæ™‚å™¨èˆ‡åˆ†æ•¸é¡¯ç¤º (æŒ‘æˆ°è³½ç”¨) -->
            <div id="challenge-header" class="hidden max-w-2xl mx-auto mt-4">
                <div class="flex justify-between items-center bg-yellow-100 p-3 rounded-t-lg border-2 border-b-0 border-yellow-300">
                    <div class="text-xl font-bold text-red-600 flex items-center gap-2">
                        <span>â±ï¸</span> <span id="timer-display">05:00</span>
                    </div>
                    <div class="text-lg font-bold text-gray-700">
                        é—œå¡: <span id="level-indicator">1</span>/10
                    </div>
                    <div class="text-xl font-bold text-blue-700 flex items-center gap-2">
                        <span>â­</span> <span id="score-display">0</span>
                    </div>
                </div>
                <!-- é€²åº¦æ¢ -->
                <div class="w-full bg-gray-200 rounded-b-lg h-2.5 dark:bg-gray-700 border-2 border-t-0 border-yellow-300 overflow-hidden">
                    <div id="challenge-progress-bar" class="bg-blue-600 h-2.5 rounded-none" style="width: 0%"></div>
                </div>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-6">

            <!-- å·¦å´ï¼šè€•åœ°æ¨¡æ“¬å€ -->
            <main id="main-game-area" class="w-full lg:w-3/5 border-4 border-yellow-800 bg-yellow-100 rounded-lg p-4 transition-all duration-300">
                
                <!-- é—œå¡æ¨™é¡Œ -->
                <h2 id="level-title" class="text-xl font-bold text-center text-yellow-800 mb-2"></h2>
                
                <!-- ç”Ÿå‘½å€¼é¡¯ç¤º -->
                <div id="lives-display" class="text-center text-3xl mb-3" aria-label="å‰©é¤˜æ©Ÿæœƒ"></div>

                <!-- è¾²å¤«æç¤º -->
                <div id="farmer-message" class="bg-white border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg shadow mb-4 min-h-[60px]">
                    è«‹åœ¨å³é‚Šçš„ã€Œè¾²ä½œç‰©å·¥å…·ç®±ã€é¸æ“‡ä¸€æ¬¾æ­£æ–¹å½¢è¾²ä½œç‰©è©¦è©¦çœ‹å§ï¼
                </div>

                <!-- è€•åœ°æ¨¡æ“¬å€åŸŸ -->
                <div class="relative w-full max-w-xl mx-auto mb-6 pt-10 pl-10">
                    <!-- é—Šåº¦æ¨™ç±¤ -->
                    <div id="farm-label-width" class="absolute top-2 left-1/2 -translate-x-1/2 text-center text-sm font-bold text-yellow-900 bg-yellow-200 px-2 py-0.5 rounded"></div>
                    <!-- é•·åº¦æ¨™ç±¤ -->
                    <div id="farm-label-length" class="absolute left-1 top-1/2 -translate-y-1/2 text-sm font-bold text-yellow-900 bg-yellow-200 px-2 py-0.5 rounded" style="writing-mode: vertical-rl; transform: translateY(-50%);"></div>
                    
                    <!-- ç¶²æ ¼å®¹å™¨ -->
                    <div id="farm-grid-container" class="relative"></div>
                    
                    <!-- é‹ªè¨­çµæœæ–‡å­— -->
                    <div id="overlay-results" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-20 p-10">
                        <div id="width-result-text" class="text-lg font-bold bg-white/80 p-2 rounded shadow mb-2 hidden"></div>
                        <div id="length-result-text" class="text-lg font-bold bg-white/80 p-2 rounded shadow hidden"></div>
                    </div>
                </div>

                <!-- æŒ‰éˆ•å€åŸŸ -->
                <div id="button-container" class="mt-6 space-y-4">
                    <button id="summary-button" class="hidden w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-blue-700 transition duration-300">
                        æŸ¥çœ‹æœ¬é—œç¸½çµï¼
                    </button>
                    <!-- ä¸‹ä¸€é—œ / æŒ‘æˆ°è³½æŒ‰éˆ• -->
                    <button id="next-level-button" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-40 bg-green-600 text-white font-extrabold py-10 px-20 rounded-3xl text-5xl shadow-[0_20px_60px_rgba(0,0,0,0.6)] hover:bg-green-500 hover:scale-105 transition-all duration-300 border-8 border-white ring-8 ring-green-600 animate-pulse-scale">
                        é–‹å§‹é™æ™‚æŒ‘æˆ°è³½ï¼ ğŸ”¥
                    </button>
                    <button id="retry-button" class="hidden w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-red-700 transition duration-300">
                        é‡æ–°æŒ‘æˆ°æœ¬é—œ
                    </button>
                </div>

            </main>

            <!-- å³å´ï¼šå·¥å…·ç®± & çµæœ -->
            <aside id="sidebar" class="w-full lg:w-2/5 transition-all duration-300">
                <!-- è¾²ä½œç‰©å·¥å…·ç®± (æŒ‰éˆ•æ¨¡å¼) -->
                <div id="toolbox-container" class="bg-gray-100 rounded-lg p-4 shadow-md">
                    <h3 class="text-lg font-bold text-gray-800 text-center mb-3">ğŸŒ¼ è¾²ä½œç‰©å·¥å…·ç®± ğŸŒ¼</h3>
                    <p class="text-sm text-center text-gray-600 mb-4">(è«‹æ‰¾å‡ºæ‰€æœ‰èƒ½é‹ªæ»¿çš„å°ºå¯¸)</p>
                    <div id="toolbox" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-3 gap-3"></div>
                </div>

                <!-- æ–°å¢ï¼šæ‰‹å‹•è¼¸å…¥å€ (ç¬¬5é—œå¾Œä½¿ç”¨) -->
                <div id="manual-input-container" class="hidden bg-yellow-100 rounded-lg p-4 shadow-md border-2 border-yellow-300">
                    <h3 class="text-lg font-bold text-yellow-900 text-center mb-3">âœï¸ è‡ªè¨‚è¾²ä½œç‰©å°ºå¯¸</h3>
                    <p class="text-sm text-center text-gray-600 mb-4">è«‹è¼¸å…¥ä½ æƒ³æ¸¬è©¦çš„é‚Šé•· (ç±³)</p>
                    
                    <div class="flex gap-2 mb-4">
                        <input type="number" id="manual-size-input" class="w-full border-2 border-yellow-400 rounded-lg p-3 text-2xl text-center focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="?" min="1">
                        <button id="manual-test-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-green-700 transition duration-200">æ¸¬è©¦</button>
                    </div>

                    <!-- æ­·å²è¨˜éŒ„ -->
                    <div class="bg-white rounded-lg p-3 min-h-[100px] border border-yellow-200">
                        <h4 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">å·²æ¸¬è©¦è¨˜éŒ„ï¼š</h4>
                        <div id="manual-history" class="flex flex-wrap gap-2">
                            <!-- JS æœƒåœ¨é€™è£¡åŠ å…¥æ¨™ç±¤ -->
                        </div>
                    </div>
                </div>

                <!-- æ¸¬è©¦çµæœ -->
                <div class="bg-blue-50 rounded-lg p-4 mt-6 shadow-md">
                    <h3 class="text-lg font-bold text-blue-800 text-center mb-4">ğŸ“‹ æ¸¬è©¦çµæœ ğŸ“‹</h3>
                    <table id="results-table" class="w-full text-center">
                        <thead>
                            <tr class="border-b-2 border-blue-200">
                                <th class="py-2">è¾²ä½œç‰©é‚Šé•·</th>
                                <th class="py-2">é—Šåº¦?</th>
                                <th class="py-2">é•·åº¦?</th>
                                <th class="py-2"><strong>é‹ªæ»¿ï¼Ÿ</strong></th>
                            </tr>
                        </thead>
                        <tbody id="results-body" class="text-gray-700"></tbody>
                    </table>
                </div>
            </aside>

        </div>
    </div>
    
    <!-- ç¸½çµå½ˆçª— (Modal) -->
    <div id="summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-lg p-8 max-w-lg w-full">
            <h2 id="summary-title" class="text-2xl font-bold text-blue-800 mb-4">æœ¬é—œç¸½çµ ğŸ’¡</h2>
            <div id="summary-text" class="text-gray-700 space-y-3"></div>
            <button id="close-modal-button" class="mt-6 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                æˆ‘æ˜ç™½äº†ï¼
            </button>
        </div>
    </div>
    
    <!-- å°æ¸¬é©—å½ˆçª— (Modal) -->
    <div id="quiz-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-40">
        <div class="modal-content bg-white rounded-lg p-8 max-w-md w-full">
            <h2 class="text-xl font-bold text-gray-800 mb-4">éå¸¸å¥½ï¼</h2>
            <p id="quiz-question" class="text-lg text-gray-700 mb-6">ä½ å­¸æœƒäº†èƒ½é‹ªæ»¿è€•åœ°çš„è¾²ä½œç‰©é‚Šé•·ï¼Œæ˜¯è€•åœ°é•·åº¦å’Œé—Šåº¦çš„...ï¼Ÿ</p>
            <div class="space-y-3">
                <button id="quiz-btn-factor" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-green-600 transition duration-300">
                    å…¬å› æ•¸
                </button>
                <button id="quiz-btn-multiple" class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-yellow-600 transition duration-300">
                    å…¬å€æ•¸
                </button>
            </div>
            <p id="quiz-feedback" class="text-center font-bold mt-4 h-6"></p>
        </div>
    </div>

    <!-- æŒ‘æˆ°è³½éé—œå½ˆçª— -->
    <div id="level-complete-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-lg p-6 max-w-sm w-full text-center shadow-2xl transform scale-100">
            <div class="text-5xl mb-2">âœ¨</div>
            <h2 class="text-2xl font-bold text-green-700 mb-2">æ­£ç¢ºï¼</h2>
            <p class="text-gray-600 font-bold">+10 åˆ†</p>
            <!-- æ‰‹å‹•ä¸‹ä¸€é—œæŒ‰éˆ• -->
            <button id="next-challenge-btn" class="mt-4 w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300 flex items-center justify-center gap-2">
                ä¸‹ä¸€é¡Œ â¡ï¸
            </button>
        </div>
    </div>
    
    <!-- æŒ‘æˆ°è³½æœ¬é—œå¤±æ•—å½ˆçª— -->
    <div id="level-fail-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-lg p-6 max-w-sm w-full text-center shadow-2xl border-4 border-red-400">
            <div class="text-5xl mb-2">ğŸ¤”</div>
            <h2 class="text-2xl font-bold text-red-700 mb-2">å†æ¥å†å²ï¼</h2>
            <p class="text-gray-600">2 æ¬¡æ©Ÿæœƒç”¨ç›¡äº†ã€‚</p>
            <p class="text-sm text-gray-500 mt-2">é»æ“ŠæŒ‰éˆ•é‡æ–°æŒ‘æˆ°æœ¬é—œï¼</p>
            <button id="restart-level-btn" class="mt-4 w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">
                é‡æ–°é–‹å§‹æœ¬é—œ
            </button>
        </div>
    </div>

    <!-- æŒ‘æˆ°è³½çµæŸå½ˆçª— -->
    <div id="challenge-end-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-8 max-w-md w-full text-center border-4 border-yellow-400">
            <div class="text-6xl mb-4">ğŸ†</div>
            <h2 class="text-3xl font-bold text-yellow-800 mb-2">æŒ‘æˆ°çµæŸï¼</h2>
            <p id="end-reason" class="text-gray-600 mb-6">ä½ å®Œæˆäº†æ‰€æœ‰çš„è€•ç¨®æŒ‘æˆ°ã€‚</p>
            
            <div class="bg-yellow-50 rounded-lg p-6 mb-6">
                <div class="text-sm text-gray-500 mb-1">æœ€çµ‚å¾—åˆ†</div>
                <div class="text-5xl font-bold text-blue-600 mb-2"><span id="final-score">0</span><span class="text-2xl text-gray-400">/100</span></div>
                <div id="final-comment" class="text-lg font-bold text-green-600">åšå¾—å¥½ï¼</div>
            </div>
            
            <button onclick="location.reload()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-blue-700 transition duration-300 shadow-lg">
                å†æ¬¡éŠç©
            </button>
        </div>
    </div>

    <script>
        // --- éŠæˆ²è³‡æ–™ ---
        // ç¬¬ä¸€é—œ (æ•™å­¸é—œ)
        const tutorialLevel = {
            width: 12,
            length: 18,
            maxToolSize: 12,
            title: "è¾²ç”°é‚Šé•·ï¼š 12ç±³ (é—Š) Ã— 18ç±³ (é•·)" 
        };

        // æŒ‘æˆ°è³½é¡Œç›® (10å€‹æ¨¡æ“¬è€•ç¨®é—œå¡)
        // æ³¨æ„ï¼šç¬¬ 5 é—œ (index 4) é–‹å§‹ä½¿ç”¨æ‰‹å‹•è¼¸å…¥
        const challengeLevels = [
            { width: 3, length: 3, maxToolSize: 3, title: "ç¬¬1é¡Œï¼š 3ç±³ (é—Š) Ã— 3ç±³ (é•·)" },
            { width: 4, length: 4, maxToolSize: 4, title: "ç¬¬2é¡Œï¼š 4ç±³ (é—Š) Ã— 4ç±³ (é•·)" },
            // ä¿®æ”¹ï¼šç¬¬3é—œæ”¹ç‚ºé•·æ–¹å½¢ (5x10)
            { width: 5, length: 10, maxToolSize: 5, title: "ç¬¬3é¡Œï¼š 5ç±³ (é—Š) Ã— 10ç±³ (é•·)" },
            { width: 4, length: 6, maxToolSize: 4, title: "ç¬¬4é¡Œï¼š 4ç±³ (é—Š) Ã— 6ç±³ (é•·)" },
            // --- ä»¥ä¸‹é–‹å§‹æ‰‹å‹•è¼¸å…¥ (æ•¸å­—è¼ƒå¤§ï¼Œä½† <=30) ---
            { width: 12, length: 15, maxToolSize: 12, title: "ç¬¬5é¡Œï¼š 12ç±³ (é—Š) Ã— 15ç±³ (é•·)" },
            { width: 18, length: 24, maxToolSize: 18, title: "ç¬¬6é¡Œï¼š 18ç±³ (é—Š) Ã— 24ç±³ (é•·)" },
            { width: 20, length: 25, maxToolSize: 20, title: "ç¬¬7é¡Œï¼š 20ç±³ (é—Š) Ã— 25ç±³ (é•·)" },
            { width: 24, length: 30, maxToolSize: 24, title: "ç¬¬8é¡Œï¼š 24ç±³ (é—Š) Ã— 30ç±³ (é•·)" },
            { width: 21, length: 28, maxToolSize: 21, title: "ç¬¬9é¡Œï¼š 21ç±³ (é—Š) Ã— 28ç±³ (é•·)" },
            { width: 20, length: 30, maxToolSize: 20, title: "ç¬¬10é¡Œï¼š 20ç±³ (é—Š) Ã— 30ç±³ (é•·)" }
        ];

        // --- ç‹€æ…‹è®Šæ•¸ ---
        let currentFarm;
        let testedSizes = {};
        let lives = 2;
        let totalCorrectFactors = 0;
        let correctFactorsFound = [];
        let gameOver = false;
        
        let currentRetryCount = 0;
        let currentErrorsMade = 0;
        let lastTestedSize = null;

        // æŒ‘æˆ°è³½è®Šæ•¸
        let isChallengeMode = false;
        let currentChallengeIndex = 0;
        let score = 0;
        let timerInterval;
        let timeLeft = 300; // 5åˆ†é˜ = 300ç§’

        // --- DOM å…ƒç´  ---
        const farmGridContainer = document.getElementById('farm-grid-container');
        const farmerMessageEl = document.getElementById('farmer-message');
        const resultsBodyEl = document.getElementById('results-body');
        const summaryButton = document.getElementById('summary-button');
        const nextLevelButton = document.getElementById('next-level-button');
        const retryButton = document.getElementById('retry-button');
        const levelTitleEl = document.getElementById('level-title');
        const livesDisplay = document.getElementById('lives-display');
        const widthResultText = document.getElementById('width-result-text');
        const lengthResultText = document.getElementById('length-result-text');
        const farmLabelWidth = document.getElementById('farm-label-width');
        const farmLabelLength = document.getElementById('farm-label-length');
        
        // å·¥å…·ç®±ç›¸é—œ (åˆ‡æ›ç”¨)
        const toolboxContainer = document.getElementById('toolbox-container');
        const toolBoxEl = document.getElementById('toolbox');
        const manualInputContainer = document.getElementById('manual-input-container');
        const manualSizeInput = document.getElementById('manual-size-input');
        const manualTestBtn = document.getElementById('manual-test-btn');
        const manualHistory = document.getElementById('manual-history');

        // Modal & Headers
        const summaryModal = document.getElementById('summary-modal');
        const summaryTitle = document.getElementById('summary-title');
        const summaryText = document.getElementById('summary-text');
        const closeModalButton = document.getElementById('close-modal-button');
        const quizModal = document.getElementById('quiz-modal');
        const quizBtnFactor = document.getElementById('quiz-btn-factor');
        const quizBtnMultiple = document.getElementById('quiz-btn-multiple');
        const quizFeedback = document.getElementById('quiz-feedback');
        
        // æŒ‘æˆ°è³½å°ˆç”¨
        const challengeHeader = document.getElementById('challenge-header');
        const timerDisplay = document.getElementById('timer-display');
        const scoreDisplay = document.getElementById('score-display');
        const levelIndicator = document.getElementById('level-indicator');
        const progressBar = document.getElementById('challenge-progress-bar');
        const levelCompleteModal = document.getElementById('level-complete-modal');
        const nextChallengeBtn = document.getElementById('next-challenge-btn'); 
        const levelFailModal = document.getElementById('level-fail-modal');
        const restartLevelBtn = document.getElementById('restart-level-btn');
        const challengeEndModal = document.getElementById('challenge-end-modal');
        const finalScoreEl = document.getElementById('final-score');
        const finalCommentEl = document.getElementById('final-comment');
        const endReasonEl = document.getElementById('end-reason');

        // --- æ ¸å¿ƒè¼”åŠ©å‡½æ•¸ ---
        function getFactors(num) {
            const factors = [];
            for (let i = 1; i <= num; i++) {
                if (num % i === 0) factors.push(i);
            }
            return factors;
        }

        function getCommonFactors(num1, num2) {
            const factors1 = getFactors(num1);
            const factors2 = getFactors(num2);
            return factors1.filter(f => factors2.includes(f));
        }
        
        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
            const content = modalElement.querySelector('.modal-content');
            if (content) setTimeout(() => content.classList.add('show'), 10);
        }

        function hideModal(modalElement) {
            const content = modalElement.querySelector('.modal-content');
            if (content) {
                content.classList.remove('show');
                setTimeout(() => modalElement.classList.add('hidden'), 300);
            } else {
                modalElement.classList.add('hidden');
            }
        }

        // --- éŠæˆ²æµç¨‹ (æ•™å­¸é—œ) ---

        function initGame() {
            isChallengeMode = false;
            currentRetryCount = 0;
            loadLevelData(tutorialLevel);
        }
        
        function loadLevelData(levelData) {
            currentFarm = levelData;
            testedSizes = {};
            gameOver = false;
            lives = 2; // æ¯ä¸€é—œé‡ç½®ç”Ÿå‘½å€¼
            correctFactorsFound = [];
            lastTestedSize = null;
            currentErrorsMade = 0;
            
            // è¨ˆç®—ç›®æ¨™
            totalCorrectFactors = getCommonFactors(currentFarm.width, currentFarm.length)
                                    .filter(f => f <= currentFarm.maxToolSize)
                                    .length;

            // UI åˆå§‹åŒ–
            levelTitleEl.textContent = currentFarm.title;
            updateLivesDisplay();
            
            farmLabelWidth.textContent = `é—Šåº¦: ${currentFarm.width}ç±³`;
            farmLabelLength.textContent = `é•·åº¦: ${currentFarm.length}ç±³`;
            farmGridContainer.style.setProperty('--aspect-ratio-val', `${currentFarm.width} / ${currentFarm.length}`);
            farmGridContainer.innerHTML = '';

            // éš±è—ä¸ç›¸é—œæŒ‰éˆ•
            summaryButton.classList.add('hidden');
            nextLevelButton.classList.add('hidden');
            retryButton.classList.add('hidden');
            widthResultText.classList.add('hidden');
            lengthResultText.classList.add('hidden');
            
            // ç”Ÿæˆçµæœè¡¨ (æ¸…ç©º)
            resultsBodyEl.innerHTML = '';

            // --- åˆ¤æ–·é¡¯ç¤ºå“ªç¨®å·¥å…·ç®± ---
            // æŒ‘æˆ°è³½ä¸”ç´¢å¼• >= 4 (ç¬¬5é—œ) ä½¿ç”¨æ‰‹å‹•è¼¸å…¥
            if (isChallengeMode && currentChallengeIndex >= 4) {
                setupManualInput();
                farmerMessageEl.innerHTML = 'è«‹æ‰¾å‡ºé€™å¡Šè€•åœ°çš„æ‰€æœ‰åˆé©è¾²ä½œç‰©ï¼Œä¸¦è¼¸å…¥é‚Šé•·æ¸¬è©¦ï¼';
            } else {
                setupButtonGrid();
                let msg = isChallengeMode 
                    ? `è«‹æ‰¾å‡ºé€™å¡Š ${currentFarm.width}x${currentFarm.length} è€•åœ°çš„æ‰€æœ‰åˆé©è¾²ä½œç‰©ï¼`
                    : 'è«‹åœ¨å³é‚Šçš„ã€Œè¾²ä½œç‰©å·¥å…·ç®±ã€é¸æ“‡ä¸€æ¬¾æ­£æ–¹å½¢è¾²ä½œç‰©è©¦è©¦çœ‹å§ï¼';
                farmerMessageEl.innerHTML = msg;
            }
            farmerMessageEl.className = 'bg-white border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg shadow mb-4 min-h-[60px]';
        }

        function setupButtonGrid() {
            toolboxContainer.classList.remove('hidden');
            manualInputContainer.classList.add('hidden');
            
            toolBoxEl.innerHTML = '';
            for (let i = 1; i <= currentFarm.maxToolSize; i++) {
                const button = document.createElement('button');
                button.textContent = `${i}ç±³`;
                button.dataset.size = i;
                button.className = 'tool-btn w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-3 px-2 rounded-lg shadow-md';
                button.addEventListener('click', () => testSize(i));
                toolBoxEl.appendChild(button);
            }
            
            // é å…ˆç”Ÿæˆè¡¨æ ¼è¡Œ
            for (let i = 1; i <= currentFarm.maxToolSize; i++) {
                addResultRow(i);
            }
        }

        function setupManualInput() {
            toolboxContainer.classList.add('hidden');
            manualInputContainer.classList.remove('hidden');
            manualSizeInput.value = '';
            manualHistory.innerHTML = ''; // æ¸…ç©ºæ­·å²
            manualSizeInput.disabled = false;
            manualTestBtn.disabled = false;
        }

        function addResultRow(size) {
            const row = document.createElement('tr');
            row.id = `result-row-${size}`;
            row.className = 'border-b border-blue-100';
            row.innerHTML = `
                <td class="py-2 font-bold">${size}ç±³</td>
                <td id="width-fit-${size}" class="py-2 text-gray-400">?</td>
                <td id="length-fit-${size}" class="py-2 text-gray-400">?</td>
                <td id="all-fit-${size}" class="py-2 text-gray-400">?</td>
            `;
            resultsBodyEl.appendChild(row);
        }

        // è™•ç†æ‰‹å‹•è¼¸å…¥
        manualTestBtn.addEventListener('click', () => {
            const val = parseInt(manualSizeInput.value);
            if (!val || val <= 0) return;
            
            // å¦‚æœé€™å€‹æ•¸å­—é‚„æ²’åœ¨è¡¨æ ¼ä¸­ï¼Œæ–°å¢ä¸€è¡Œ
            if (!document.getElementById(`result-row-${val}`)) {
                addResultRow(val);
            }
            
            testSize(val);
            manualSizeInput.value = '';
            manualSizeInput.focus();
        });
        
        // æ”¯æ´ Enter éµæäº¤
        manualSizeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') manualTestBtn.click();
        });

        function testSize(size) {
            if (gameOver || testedSizes[size]) return;
            
            lastTestedSize = size;
            const widthRemainder = currentFarm.width % size;
            const lengthRemainder = currentFarm.length % size;
            const fitsWidth = widthRemainder === 0;
            const fitsLength = lengthRemainder === 0;
            const fitsAll = fitsWidth && fitsLength;

            // æ¨™è¨˜æŒ‰éˆ• (å¦‚æœæ˜¯æŒ‰éˆ•æ¨¡å¼)
            const button = toolBoxEl.querySelector(`[data-size="${size}"]`);
            if(button) button.classList.add('tested');
            
            // æ¨™è¨˜æ‰‹å‹•æ­·å² (å¦‚æœæ˜¯æ‰‹å‹•æ¨¡å¼)
            if (isChallengeMode && currentChallengeIndex >= 4) {
                const badge = document.createElement('span');
                badge.className = `px-2 py-1 rounded text-sm font-bold border ${fitsAll ? 'bg-green-100 text-green-700 border-green-300' : 'bg-red-100 text-red-700 border-red-300'}`;
                badge.textContent = `${size}ç±³ ${fitsAll ? 'âœ…' : 'âŒ'}`;
                manualHistory.appendChild(badge);
            }

            testedSizes[size] = true;

            // è¦–è¦ºåŒ–
            visualizeTest(size, fitsWidth, fitsLength, widthRemainder, lengthRemainder);
            updateTable(size, fitsWidth, fitsLength, fitsAll);
            updateFarmerMessage(size, fitsWidth, fitsLength, fitsAll);
            
            // é‚è¼¯åˆ¤æ–·
            if (fitsAll) {
                if (!correctFactorsFound.includes(size)) correctFactorsFound.push(size);
                
                // æª¢æŸ¥æ˜¯å¦æ‰¾é½Šæ‰€æœ‰ç­”æ¡ˆ
                if (correctFactorsFound.length === totalCorrectFactors) {
                    if (isChallengeMode) {
                        winChallengeLevel();
                    } else {
                        winTutorialLevel();
                    }
                }
            } else {
                lives--;
                currentErrorsMade++;
                updateLivesDisplay();
                if (lives === 0) {
                     if (isChallengeMode) {
                        showLevelFailModal();
                    } else {
                        loseTutorialLevel();
                    }
                }
            }
        }
        
        // --- è¦–è¦ºåŒ–é‚è¼¯ ---
        function visualizeTest(size, fitsWidth, fitsLength, widthRemainder, lengthRemainder) {
            farmGridContainer.innerHTML = '';
            widthResultText.classList.add('hidden');
            lengthResultText.classList.add('hidden');
            
            if (size === null) return;

            const tileWidthPerc = (size / currentFarm.width) * 100;
            const tileLengthPerc = (size / currentFarm.length) * 100;
            const gapWidthPerc = (widthRemainder / currentFarm.width) * 100;
            const gapLengthPerc = (lengthRemainder / currentFarm.length) * 100;

            const numTilesX = Math.floor(currentFarm.width / size);
            const numTilesY = Math.floor(currentFarm.length / size);

            let delay = 0;
            const totalTiles = numTilesX * numTilesY;
            const stepDelay = totalTiles > 50 ? 1 : 5;

            for (let y = 0; y < numTilesY; y++) {
                for (let x = 0; x < numTilesX; x++) {
                    createPlantTile(x * tileWidthPerc, y * tileLengthPerc, tileWidthPerc, tileLengthPerc, true, delay, 'ğŸŒ±');
                    delay += stepDelay;
                }
            }

            if (!fitsWidth) {
                for (let y = 0; y < numTilesY; y++) {
                    createPlantTile(numTilesX * tileWidthPerc, y * tileLengthPerc, gapWidthPerc, tileLengthPerc, false, delay, 'ğŸš«');
                    delay += stepDelay;
                }
            }
            if (!fitsLength) {
                for (let x = 0; x < numTilesX; x++) {
                    createPlantTile(x * tileWidthPerc, numTilesY * tileLengthPerc, tileWidthPerc, gapLengthPerc, false, delay, 'ğŸš«');
                    delay += stepDelay;
                }
            }
            if (!fitsWidth && !fitsLength) {
                createPlantTile(numTilesX * tileWidthPerc, numTilesY * tileLengthPerc, gapWidthPerc, gapLengthPerc, false, delay, 'ğŸš«');
                delay += stepDelay;
            }

            setTimeout(() => {
                widthResultText.classList.remove('hidden');
                widthResultText.textContent = fitsWidth ? `âœ… é—Šåº¦ (${currentFarm.width}ç±³) å‰›å‰›å¥½ï¼` : `âŒ é—Šåº¦ (${currentFarm.width}ç±³) å‰©ä¸‹ ${widthRemainder}ç±³ï¼`;
                widthResultText.className = fitsWidth ? 'text-lg font-bold bg-green-100/90 p-2 rounded shadow text-green-700' : 'text-lg font-bold bg-red-100/90 p-2 rounded shadow text-red-700';
            }, delay + 100);

            setTimeout(() => {
                lengthResultText.classList.remove('hidden');
                lengthResultText.textContent = fitsLength ? `âœ… é•·åº¦ (${currentFarm.length}ç±³) å‰›å‰›å¥½ï¼` : `âŒ é•·åº¦ (${currentFarm.length}ç±³) å‰©ä¸‹ ${lengthRemainder}ç±³ï¼`;
                lengthResultText.className = fitsLength ? 'text-lg font-bold bg-green-100/90 p-2 rounded shadow text-green-700' : 'text-lg font-bold bg-red-100/90 p-2 rounded shadow text-red-700';
            }, delay + 200);
        }

        function createPlantTile(xPerc, yPerc, wPerc, hPerc, isFit, delay, emoji) {
            const tile = document.createElement('div');
            tile.className = `tile-base ${isFit ? 'plant-tile' : 'gap-tile'}`;
            tile.style.setProperty('--tile-x', `${xPerc}%`);
            tile.style.setProperty('--tile-y', `${yPerc}%`);
            tile.style.setProperty('--tile-width', `${wPerc}%`);
            tile.style.setProperty('--tile-height', `${hPerc}%`);
            tile.style.animationDelay = `${delay}ms`;
            if (wPerc > 5 && hPerc > 5) tile.textContent = emoji || '';
            farmGridContainer.appendChild(tile);
        }
        
        // --- UI æ›´æ–° helpers ---
        function updateLivesDisplay() {
            livesDisplay.innerHTML = 'â¤ï¸'.repeat(lives) + 'ğŸ–¤'.repeat(2 - lives);
        }

        function updateTable(size, fitsWidth, fitsLength, fitsAll) {
            document.getElementById(`width-fit-${size}`).innerHTML = fitsWidth ? 'âœ…' : 'âŒ';
            document.getElementById(`width-fit-${size}`).className = fitsWidth ? 'text-green-600' : 'text-red-600';
            document.getElementById(`length-fit-${size}`).innerHTML = fitsLength ? 'âœ…' : 'âŒ';
            document.getElementById(`length-fit-${size}`).className = fitsLength ? 'text-green-600' : 'text-red-600';
            const allFitCell = document.getElementById(`all-fit-${size}`);
            allFitCell.innerHTML = fitsAll ? 'ğŸŒŸ <strong>èƒ½é‹ªæ»¿</strong>' : 'ğŸ˜¥';
            allFitCell.className = fitsAll ? 'text-yellow-600 font-bold' : 'text-gray-500';
            document.getElementById(`result-row-${size}`).classList.add('bg-blue-100');
        }
        
        // --- æ ¸å¿ƒæ›´æ–°ï¼šä¿®æ”¹è¾²å¤«è¨Šæ¯ä»¥é¡¯ç¤ºå¯¦éš›æ•¸å­— ---
        function updateFarmerMessage(size, fitsWidth, fitsLength, fitsAll) {
            let message = '';
            let a_class = '';
            const w = currentFarm.width;
            const l = currentFarm.length;

            if (fitsAll) {
                // ä¿®æ”¹ï¼šæåŠæ•¸å­—åŠã€Œå…¬å› æ•¸ã€
                message = `ğŸŒŸ æ­£ç¢ºï¼${size} æ˜¯ ${w} å’Œ ${l} çš„å…¬å› æ•¸ã€‚`;
                a_class = 'bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-lg shadow mb-4 min-h-[60px]';
            } else if (fitsWidth && !fitsLength) {
                message = `ğŸ¤” éŒ¯èª¤ã€‚${size} æ˜¯ ${w} çš„å› æ•¸ï¼Œä½†ä¸æ˜¯ ${l} çš„å› æ•¸ã€‚`;
                a_class = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg shadow mb-4 min-h-[60px]';
            } else if (!fitsWidth && fitsLength) {
                message = `ğŸ¤” éŒ¯èª¤ã€‚${size} æ˜¯ ${l} çš„å› æ•¸ï¼Œä½†ä¸æ˜¯ ${w} çš„å› æ•¸ã€‚`;
                a_class = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg shadow mb-4 min-h-[60px]';
            } else {
                message = `ğŸ˜¥ éŒ¯èª¤ã€‚${size} ä¸æ˜¯ ${w} æˆ– ${l} çš„å› æ•¸ã€‚(å‰©ä¸‹ ${lives} æ¬¡æ©Ÿæœƒ)`;
                a_class = 'bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg shadow mb-4 min-h-[60px]';
            }
            farmerMessageEl.innerHTML = message;
            farmerMessageEl.className = a_class;
        }

        function disableToolbox() {
            toolBoxEl.querySelectorAll('.tool-btn').forEach(btn => {
                btn.disabled = true;
                if (!btn.classList.contains('tested')) btn.classList.add('tested');
            });
            // ç¦ç”¨æ‰‹å‹•è¼¸å…¥
            manualSizeInput.disabled = true;
            manualTestBtn.disabled = true;
        }
        
        // --- æ•™å­¸é—œçµæœ ---
        function winTutorialLevel() {
            gameOver = true;
            disableToolbox();
            let attemptText = currentRetryCount === 0 ? "ä½ ç¬¬ 1 æ¬¡å˜—è©¦å°±æˆåŠŸäº†ï¼" : `ä½ ç¸½å…±å˜—è©¦äº† ${currentRetryCount + 1} æ¬¡ã€‚`;
            farmerMessageEl.innerHTML = `ğŸ† <strong>æŒ‘æˆ°æˆåŠŸï¼</strong> ${attemptText} ä½ æ‰¾åˆ°äº†æ‰€æœ‰ ${totalCorrectFactors} æ¬¾é©åˆçš„è¾²ä½œç‰©ï¼`;
            farmerMessageEl.className = 'bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-lg shadow mb-4 min-h-[60px]';
            setTimeout(() => showQuizModal(), 500);
        }

        function loseTutorialLevel() {
            gameOver = true;
            disableToolbox();
            farmerMessageEl.innerHTML = 'ğŸ˜¥ 2æ¬¡æ©Ÿæœƒç”¨å®Œäº†ã€‚åˆ¥ç°å¿ƒï¼Œå†è©¦ä¸€æ¬¡å§ï¼';
            farmerMessageEl.className = 'bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg shadow mb-4 min-h-[60px]';
            retryButton.classList.remove('hidden');
            retryButton.onclick = () => { currentRetryCount++; loadLevelData(tutorialLevel); };
        }

        function showSummary() {
            const { width, length, maxToolSize } = currentFarm;
            // åªåœ¨ç¬¬ä¸€é—œé¡¯ç¤ºç¸½çµæ•™å­¸
            summaryTitle.textContent = `ç¬¬ 1 é—œç¸½çµ ğŸ’¡`;
            summaryText.innerHTML = `
                <p>æˆ‘å€‘çš„è€•åœ°æ˜¯ <strong>${width}ç±³ Ã— ${length}ç±³</strong>ã€‚</p>
                <p class="mt-2">è¦å°‡è¾²ä½œç‰©ã€Œé‹ªæ»¿ã€ï¼Œé‚Šé•·å¿…é ˆåŒæ™‚æ˜¯ ${width} <strong>å’Œ</strong> ${length} çš„å› æ•¸ã€‚</p>
                <p class="text-xl font-bold text-center text-blue-700 mt-2">æˆ‘å€‘ç¨±é€™äº›æ•¸ç‚ºã€Œå…¬å› æ•¸ã€ï¼</p>
            `;
            showModal(summaryModal);
            nextLevelButton.classList.remove('hidden');
        }
        
        // --- æŒ‘æˆ°è³½é‚è¼¯ ---

        // å•Ÿå‹•
        nextLevelButton.addEventListener('click', startChallengeSequence);

        function startChallengeSequence() {
            hideModal(summaryModal);
            isChallengeMode = true;
            currentChallengeIndex = 0;
            score = 0;
            timeLeft = 300; // 5åˆ†é˜
            
            // UI æ›´æ–°
            challengeHeader.classList.remove('hidden');
            scoreDisplay.textContent = score;
            updateProgressBar();
            
            startTimer();
            loadChallengeLevel(0);
        }

        function loadChallengeLevel(index) {
            if (index >= challengeLevels.length) {
                endChallenge("ä½ å®Œæˆäº†æ‰€æœ‰æŒ‘æˆ°ï¼");
                return;
            }
            
            currentChallengeIndex = index;
            levelIndicator.textContent = index + 1;
            updateProgressBar();
            
            // è¼‰å…¥é—œå¡æ•¸æ“š (èˆ‡æ•™å­¸é—œå…±ç”¨å‡½æ•¸)
            loadLevelData(challengeLevels[index]);
        }

        // --- æŒ‘æˆ°é—œå¡å¤±æ•—è™•ç† ---
        function showLevelFailModal() {
            gameOver = true;
            disableToolbox();
            showModal(levelFailModal);
        }

        restartLevelBtn.addEventListener('click', () => {
            hideModal(levelFailModal);
            loadChallengeLevel(currentChallengeIndex); // é‡æ–°è¼‰å…¥ç•¶å‰é—œå¡
        });
        
        function updateProgressBar() {
            const percent = (currentChallengeIndex / challengeLevels.length) * 100;
            progressBar.style.width = `${percent}%`;
        }

        function winChallengeLevel() {
            gameOver = true;
            disableToolbox();
            
            // åŠ åˆ†
            score += 10;
            scoreDisplay.textContent = score;
            scoreDisplay.parentElement.classList.add('scale-125');
            setTimeout(() => scoreDisplay.parentElement.classList.remove('scale-125'), 200);

            // é¡¯ç¤ºéé—œå½ˆçª—
            showModal(levelCompleteModal);
        }
        
        // æ‰‹å‹•ä¸‹ä¸€é—œæŒ‰éˆ•äº‹ä»¶
        nextChallengeBtn.addEventListener('click', () => {
            hideModal(levelCompleteModal);
            loadChallengeLevel(currentChallengeIndex + 1);
        });
        
        function loseChallengeGame(reason) {
            gameOver = true;
            disableToolbox();
            clearInterval(timerInterval);
            endChallenge(reason);
        }

        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    loseChallengeGame("æ™‚é–“åˆ°äº†ï¼");
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (timeLeft <= 30) {
                timerDisplay.parentElement.classList.add('animate-pulse');
            }
        }

        function endChallenge(reason) {
            clearInterval(timerInterval);
            finalScoreEl.textContent = score;
            endReasonEl.textContent = reason;
            
            if (score === 100) {
                finalCommentEl.textContent = "å¤ªç¥äº†ï¼ä½ æ˜¯æ•¸å­¸å¤©æ‰ï¼ğŸŒŸ";
                finalCommentEl.className = "text-lg font-bold text-yellow-600";
            } else if (score >= 60) {
                finalCommentEl.textContent = "åšå¾—å¾ˆå¥½ï¼ç¹¼çºŒä¿æŒï¼ğŸ‘";
                finalCommentEl.className = "text-lg font-bold text-green-600";
            } else {
                finalCommentEl.textContent = "ä¸è¦ç°å¿ƒï¼Œå¤šç·´ç¿’å°±æœƒé€²æ­¥ï¼ğŸŒ±";
                finalCommentEl.className = "text-lg font-bold text-gray-600";
            }
            
            showModal(challengeEndModal);
        }

        // --- äº‹ä»¶ç¶å®š ---
        summaryButton.addEventListener('click', showSummary);
        closeModalButton.addEventListener('click', () => hideModal(summaryModal));
        
        // æ•™å­¸é—œçš„å°æ¸¬é©—
        function showQuizModal() {
            quizFeedback.textContent = '';
            quizBtnFactor.disabled = false;
            quizBtnMultiple.disabled = false;
            showModal(quizModal);
        }
        function handleQuizChoice(isCorrect) {
            if (isCorrect) {
                quizFeedback.textContent = 'ç­”å°äº†ï¼ğŸŒŸ æ˜¯å…¬å› æ•¸ï¼';
                quizFeedback.className = 'text-center font-bold mt-4 h-6 text-green-600';
                quizBtnFactor.disabled = true;
                quizBtnMultiple.disabled = true;
                setTimeout(() => { hideModal(quizModal); showSummary(); }, 1500);
            } else {
                quizFeedback.textContent = 'å†è©¦ä¸€æ¬¡ï¼ä¸æ˜¯å…¬å€æ•¸å–”... ğŸ¤”';
                quizFeedback.className = 'text-center font-bold mt-4 h-6 text-red-600';
            }
        }
        quizBtnFactor.addEventListener('click', () => handleQuizChoice(true));
        quizBtnMultiple.addEventListener('click', () => handleQuizChoice(false));

        // Resize è™•ç†
        window.addEventListener('resize', () => {
            if (lastTestedSize) {
                const size = lastTestedSize;
                const widthRemainder = currentFarm.width % size;
                const lengthRemainder = currentFarm.length % size;
                const fitsWidth = widthRemainder === 0;
                const fitsLength = lengthRemainder === 0;
                visualizeTest(size, fitsWidth, fitsLength, widthRemainder, lengthRemainder);
            } else {
                farmGridContainer.innerHTML = '';
            }
        });

        // å•Ÿå‹•éŠæˆ²
        initGame();

    </script>
</body>
</html>