<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å°è¾²å¤«è€•ç¨®æ¨‚ (æŒ‘æˆ°ç‰ˆ) ğŸšœ</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            overscroll-behavior: none; /* é˜²æ­¢ "pull-to-refresh" */
            touch-action: manipulation;
        }
        
        /* è€•åœ°å®¹å™¨ */
        #farm-grid-container {
            display: block; 
            position: relative;
            border: 4px solid #8B4513; /* åœŸå£¤é¡è‰² */
            background-color: #fcf8e3; /* æ·ºé»ƒè‰²ä»£è¡¨æ³¥åœŸ */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            overflow: hidden; 
            
            /* è‡ªé©æ‡‰å¤§å° */
            height: 50vh; /* ç¨å¾®èª¿å°ä¸€é»ç•™ç©ºé–“çµ¦ä¸‹é¢çš„æŒ‰éˆ• */
            width: auto;
            aspect-ratio: var(--aspect-ratio-val, 1 / 1);
            
            /* é™åˆ¶ */
            max-width: 95%;
            margin: 0 auto; 
        }

        /* é‡å°æ‰‹æ©Ÿç›´å‘è¢å¹•çš„å„ªåŒ– */
        @media (orientation: portrait) {
            #farm-grid-container {
                width: 90%;
                height: auto;
                max-height: 45vh;
            }
        }

        /* é‹ªç£šæ•ˆæœ (å…±åŒæ¨£å¼) */
        .tile-base {
            position: absolute;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            /* å‹•ç•«ç”± JS æ§åˆ¶ï¼Œå°æ ¼å­å¯èƒ½ä¸ä½¿ç”¨å‹•ç•« */
            transform-origin: center;
            line-height: 1;
            /* ä½¿ç”¨ CSS è®Šæ•¸è¨ˆç®— */
            width: var(--tile-width);
            height: var(--tile-height);
            left: var(--tile-x);
            top: var(--tile-y);
            
            /* ç¢ºä¿æ•¸å­—åœ¨å°æ ¼å­ä¹Ÿèƒ½é¡¯ç¤ºï¼Œä½†æœƒè‡ªå‹•ç¸®å° */
            font-size: clamp(0.5rem, 1.5vmin, 1.2rem); 
            overflow: hidden;
        }
        
        /* é‹ªç£šæ•ˆæœï¼šä¿®æ­£é‚Šç•Œ */
        .plant-tile {
            background-color: #22c55e; /* green-500 */
            border: 1px solid #16a34a; /* darker green */
            opacity: 0.9; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 10;
            color: white;
        }
        /* å°æ ¼å­çš„æ¨£å¼ (ç„¡é‚Šæ¡†) */
        .plant-tile.small-tile {
            border: 0.5px solid rgba(22, 163, 74, 0.3); /* è¼•å¾®é‚Šæ¡† */
            box-shadow: none;
            opacity: 1;
        }

        .gap-tile {
            background-color: #ef4444; /* red-500 */
            border: 1px dashed white;
            opacity: 0.7;
            z-index: 10;
            color: white;
            font-size: clamp(0.7rem, 1.5vmin, 1.2rem);
            padding: 2px;
            white-space: nowrap;
        }
        
        /* å®šç¾©æ·¡å…¥å‹•ç•« Class */
        .animate-fade-in {
            animation: tile-fade-in 0.3s ease-out forwards;
        }

        @keyframes tile-fade-in {
            0% { opacity: 0; transform: scale(0.7); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .gap-tile { opacity: 0.7; }

        /* å·¥å…·ç®±æŒ‰éˆ• */
        .tool-btn {
            transition: all 0.2s ease;
        }
        
        .tool-btn.tested {
            background-color: #6b7280;
            color: white;
            opacity: 0.7;
            cursor: not-allowed; 
        }

        .review-enabled .tool-btn.tested {
            cursor: pointer;
            opacity: 0.8;
        }
        .review-enabled .tool-btn.tested:hover {
            opacity: 1;
            background-color: #4b5563;
        }

        .tool-btn:disabled {
            background-color: #9ca3af;
            color: #e5e7eb;
            opacity: 0.5;
            cursor: not-allowed !important;
            transform: scale(0.95);
        }

        /* æ„›å¿ƒ (ç”Ÿå‘½å€¼) */
        #lives-display {
            font-size: 1.5rem;
            letter-spacing: 0.1em;
            line-height: 1;
        }
        
        /* å½ˆçª—å‹•ç•« */
        .modal-content {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: scale(0.95);
            opacity: 0;
        }
        .modal-content.show {
            transform: scale(1);
            opacity: 1;
        }

        /* æŒ‘æˆ°è³½é€²åº¦æ¢ */
        #challenge-progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        /* ä¸‹ä¸€é—œæŒ‰éˆ•å‹•ç•« */
        @keyframes pulse-scale {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }
        .animate-pulse-scale {
            animation: pulse-scale 2s infinite;
        }

        /* iPad æ»¾å‹•æ¢å„ªåŒ– */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<!-- å…¨è¢å¹• Flex ä½ˆå±€ -->
<body class="bg-yellow-50 h-screen w-screen overflow-hidden flex flex-col">

    <!-- é ‚éƒ¨ Header -->
    <header class="bg-white shadow-md z-30 flex-none px-4 py-2 flex justify-between items-center border-b border-yellow-200 h-16">
        <div class="flex items-center gap-3 overflow-hidden">
            <h1 class="text-xl md:text-2xl font-bold text-yellow-900 whitespace-nowrap flex-none">
                ğŸšœ å°å°è¾²å¤«
            </h1>
            <!-- é—œå¡æ¨™é¡Œ -->
            <div id="header-level-title" class="hidden md:block bg-yellow-100 text-yellow-800 px-3 py-1 rounded-lg text-sm font-bold truncate">
                <!-- JS æœƒå¡«å…¥æ¨™é¡Œ -->
            </div>
        </div>
        
        <!-- è¨ˆæ™‚å™¨èˆ‡åˆ†æ•¸é¡¯ç¤º (æŒ‘æˆ°è³½ç”¨) -->
        <div id="challenge-header" class="hidden flex items-center gap-2 md:gap-4 bg-yellow-50 px-2 md:px-3 py-1 rounded-full border border-yellow-300">
            <div class="font-bold text-red-600 flex items-center gap-1 text-sm">
                <span>â±ï¸</span> <span id="timer-display" class="w-10 text-center">05:00</span>
            </div>
            <div class="font-bold text-gray-700 text-sm">
                é—œå¡: <span id="level-indicator">1</span>/10
            </div>
            <div class="font-bold text-blue-700 flex items-center gap-1 text-sm">
                <span>â­</span> <span id="score-display">0</span>
            </div>
            <!-- é€²åº¦æ¢ -->
            <div class="hidden lg:block w-16 bg-gray-200 rounded-full h-2 overflow-hidden border border-gray-200">
                <div id="challenge-progress-bar" class="bg-blue-600 h-full rounded-full" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- ç”Ÿå‘½å€¼é¡¯ç¤º -->
        <div id="lives-display" class="text-xl"></div>
    </header>

    <!-- ä¸»å…§å®¹å€ï¼šå·¦å³åˆ†å‰² -->
    <div class="flex-1 flex flex-row overflow-hidden relative">

        <!-- å·¦å´ï¼šè€•åœ°æ¨¡æ“¬å€ (ä½” 60% - 65%) -->
        <main id="main-game-area" class="w-[60%] md:w-[65%] h-full bg-yellow-100/50 relative flex flex-col p-2">
            
            <!-- æ‰‹æ©Ÿç‰ˆæ¨™é¡Œ -->
            <div id="mobile-level-title" class="md:hidden text-center text-yellow-900 font-bold text-sm mb-1 px-2 py-1 bg-yellow-200/50 rounded flex-none"></div>

            <!-- è€•åœ°é¡¯ç¤ºå€åŸŸ (Flex 1 ä½”æ»¿å‰©é¤˜ç©ºé–“) -->
            <div class="flex-1 w-full flex flex-col items-center justify-center relative">
                
                <!-- è€•åœ°å®¹å™¨çš„å¤–å±¤åŒ…è£ -->
                <div class="relative flex items-center justify-center p-6 w-full h-full flex-col">
                    
                    <div class="relative w-full">
                        <!-- é—Šåº¦æ¨™ç±¤ (å·²ä¿®æ”¹ä½ç½®è‡³ -top-8) -->
                        <div id="farm-label-width" class="absolute -top-8 left-1/2 -translate-x-1/2 text-center text-xs md:text-sm font-bold text-white bg-yellow-800/90 px-3 py-0.5 rounded-full shadow-sm z-20 whitespace-nowrap"></div>
                        
                        <!-- é•·åº¦æ¨™ç±¤ -->
                        <div id="farm-label-length" class="absolute left-0 top-1/2 -translate-y-1/2 text-xs md:text-sm font-bold text-white bg-yellow-800/90 px-3 py-0.5 rounded-full shadow-sm z-20 whitespace-nowrap" style="writing-mode: vertical-rl; transform: translateY(-50%);"></div>
                        
                        <!-- è€•åœ°ç¶²æ ¼ -->
                        <div id="farm-grid-container" class="bg-yellow-50 shadow-2xl rounded-sm border-4 border-yellow-900 z-10"></div>
                        
                        <!-- é‹ªè¨­çµæœæ–‡å­— (ç–ŠåŠ åœ¨ç¶²æ ¼ä¸Šï¼Œä½æ–¼ä¸­å¤®) -->
                        <div id="overlay-results" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-20">
                            <div id="width-result-text" class="text-base md:text-xl font-bold bg-white/90 p-2 md:p-3 rounded-lg shadow-lg mb-2 hidden transform transition-all border border-gray-200"></div>
                            <div id="length-result-text" class="text-base md:text-xl font-bold bg-white/90 p-2 md:p-3 rounded-lg shadow-lg hidden transform transition-all border border-gray-200"></div>
                        </div>
                    </div>

                    <!-- é–‹å§‹æŒ‘æˆ°æŒ‰éˆ•å€ (æ–°ä½ç½®ï¼šè€•åœ°ä¸‹æ–¹) -->
                    <div id="start-challenge-container" class="w-full flex justify-center mt-4 hidden z-40">
                        <button id="start-challenge-btn" class="bg-green-600 text-white font-extrabold py-3 px-8 rounded-full text-xl shadow-lg hover:bg-green-700 hover:scale-105 transition-all duration-300 border-4 border-white ring-4 ring-green-300 animate-pulse">
                            ğŸ”¥ æº–å‚™å¥½äº†ï¼Ÿé–‹å§‹é™æ™‚æŒ‘æˆ°ï¼
                        </button>
                    </div>

                </div>

            </div>

            <!-- è¾²å¤«æç¤º (å›ºå®šåœ¨åº•éƒ¨) -->
            <div id="farmer-message" class="flex-none w-full bg-white/95 backdrop-blur-sm border-l-8 border-yellow-500 text-yellow-900 p-3 rounded-xl shadow-lg z-30 transition-all duration-300 min-h-[60px] flex items-center text-sm md:text-base font-medium mb-2">
                è«‹åœ¨å³é‚Šçš„ã€Œè¾²ä½œç‰©å·¥å…·ç®±ã€é¸æ“‡ä¸€æ¬¾æ­£æ–¹å½¢è¾²ä½œç‰©è©¦è©¦çœ‹å§ï¼
            </div>

            <!-- èˆŠçš„æŒ‰éˆ•å±¤ (ç¾åœ¨åªç”¨ä¾†æ”¾æ•™å­¸é—œå®ŒæˆæŒ‰éˆ•) -->
            <div id="button-container" class="pointer-events-none absolute inset-0 z-40 flex items-center justify-center">
                <!-- å®Œæˆæ•™å­¸é—œæŒ‰éˆ• (å·²éš±è—ï¼Œç¾åœ¨ç›´æ¥è§¸ç™¼å•ç­”) -->
                <button id="complete-tutorial-btn" class="hidden">
                    ğŸ† æŒ‘æˆ°æˆåŠŸï¼
                </button>
                
                <!-- ä¸‹ä¸€é—œ / æŒ‘æˆ°è³½æŒ‰éˆ• (é€™å¯èƒ½åœ¨èˆŠç‰ˆæœ‰ç”¨åˆ°ï¼Œä¿ç•™ä»¥é˜²è¬ä¸€ï¼Œä½†éš±è—) -->
                <button id="next-level-button" class="pointer-events-auto hidden bg-green-600 text-white font-extrabold py-6 px-10 md:py-8 md:px-14 rounded-3xl text-2xl md:text-4xl shadow-[0_20px_60px_rgba(0,0,0,0.6)] hover:bg-green-500 hover:scale-105 transition-all duration-300 border-8 border-white ring-8 ring-green-600 animate-pulse-scale">
                    é–‹å§‹é™æ™‚æŒ‘æˆ°è³½ï¼ ğŸ”¥
                </button>
                
                <!-- é‡æ–°æŒ‘æˆ°æŒ‰éˆ• -->
                <button id="retry-button" class="pointer-events-auto hidden absolute bottom-24 bg-red-600 text-white font-bold py-2 px-6 rounded-xl text-lg hover:bg-red-700 transition duration-300 shadow-lg border-2 border-white">
                    é‡æ–°æŒ‘æˆ°æœ¬é—œ
                </button>
                
                <!-- éš±è—çš„æŒ‰éˆ•ï¼Œç”¨æ–¼ç›¸å®¹æ€§ -->
                <button id="summary-button" class="hidden">hidden</button> 
            </div>

        </main>

        <!-- å³å´ï¼šå·¥å…·ç®± & çµæœ (ä½” 40% - 35%) -->
        <aside id="sidebar" class="w-[40%] md:w-[35%] h-full bg-white shadow-xl z-20 flex flex-col border-l border-gray-200">
            
            <!-- ä¸ŠåŠéƒ¨ï¼šå·¥å…·ç®± (é™åˆ¶é«˜åº¦ï¼Œè®“ä½çµ¦çµæœ) -->
            <div class="h-auto max-h-[40%] overflow-y-auto p-3 md:p-4 bg-gray-50 flex-none border-b border-gray-200">
                <!-- è¾²ä½œç‰©å·¥å…·ç®± (æŒ‰éˆ•æ¨¡å¼) -->
                <div id="toolbox-container" class="bg-white rounded-2xl p-3 md:p-4 shadow-sm border border-gray-100">
                    <h3 class="text-base md:text-lg font-bold text-gray-800 text-center mb-1">ğŸŒ¼ è¾²ä½œç‰©å·¥å…·ç®±</h3>
                    <p class="text-xs text-center text-gray-500 mb-3">(é»æ“Šå°ºå¯¸é€²è¡Œæ¸¬è©¦)</p>
                    <div id="toolbox" class="grid grid-cols-2 lg:grid-cols-3 gap-2"></div>
                </div>

                <!-- æ‰‹å‹•è¼¸å…¥å€ (ç¬¬8é—œå¾Œ) -->
                <div id="manual-input-container" class="hidden bg-yellow-50 rounded-2xl p-3 md:p-4 shadow-sm border-2 border-yellow-200">
                    <h3 class="text-base md:text-lg font-bold text-yellow-900 text-center mb-1">âœï¸ è‡ªè¨‚å°ºå¯¸</h3>
                    <p class="text-xs text-center text-gray-600 mb-3">è«‹è‡ªè¡Œè¼¸å…¥é‚Šé•· (ç±³)</p>
                    
                    <div class="flex gap-2 mb-3">
                        <input type="number" id="manual-size-input" class="w-full border-2 border-yellow-400 rounded-xl p-2 text-lg text-center focus:outline-none focus:ring-2 focus:ring-yellow-400" placeholder="?" min="1">
                        <button id="manual-test-btn" class="bg-green-600 text-white font-bold py-2 px-3 rounded-xl shadow-md hover:bg-green-700 active:scale-95 transition duration-200 whitespace-nowrap text-sm">æ¸¬è©¦</button>
                    </div>

                    <!-- æ­·å²è¨˜éŒ„ -->
                    <div class="bg-white rounded-xl p-2 min-h-[80px] border border-gray-200 shadow-inner">
                        <h4 class="text-xs font-bold text-gray-400 mb-1 uppercase tracking-wide">å·²æ¸¬è©¦è¨˜éŒ„ï¼š</h4>
                        <div id="manual-history" class="flex flex-wrap gap-1 overflow-y-auto max-h-24"></div>
                    </div>
                </div>
            </div>

            <!-- ä¸‹åŠéƒ¨ï¼šçµæœè¡¨æ ¼ (ä½”æ“šå‰©é¤˜ç©ºé–“ flex-1) -->
            <div class="flex-1 bg-blue-50 p-2 md:p-3 flex flex-col overflow-hidden">
                <h3 class="text-sm md:text-base font-bold text-blue-800 text-center mb-2 flex-none">ğŸ“‹ æ¸¬è©¦çµæœ</h3>
                <div class="flex-1 overflow-y-auto pr-1">
                    <table id="results-table" class="w-full text-center text-xs md:text-sm border-separate border-spacing-0 table-fixed">
                        <thead class="sticky top-0 bg-blue-100 text-blue-900 shadow-sm z-10">
                            <tr>
                                <th class="py-3 px-1 font-bold border-b border-blue-200 w-1/4">é‚Šé•·</th>
                                <th class="py-3 px-1 font-bold border-b border-blue-200 w-1/4">é—Šåº¦?</th>
                                <th class="py-3 px-1 font-bold border-b border-blue-200 w-1/4">é•·åº¦?</th>
                                <th class="py-3 px-1 font-bold border-b border-blue-200 w-1/4">é‹ªæ»¿?</th>
                            </tr>
                        </thead>
                        <tbody id="results-body" class="text-gray-700 bg-white"></tbody>
                    </table>
                </div>
            </div>
        </aside>

    </div>
    
    <!-- HCF äº’å‹•æ¸¬é©—å½ˆçª— (æ–°) -->
    <div id="hcf-quiz-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-6 max-w-lg w-full shadow-2xl border-4 border-yellow-200">
            <div id="quiz-step-1">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">æ­å–œï¼ä½ æ‰¾åˆ°äº†æ‰€æœ‰åˆé©çš„è¾²ä½œç‰©ï¼</h2>
                <p class="text-lg text-gray-700 mb-6 text-center leading-relaxed">
                    èƒ½å¤ é‹ªæ»¿è€•åœ°çš„è¾²ä½œç‰©é‚Šé•·æ˜¯<br>
                    <span class="font-bold text-green-600">1ç±³ï¼Œ2ç±³ï¼Œ4ç±³ï¼Œ8ç±³</span><br>
                    å®ƒå€‘æ˜¯è€•åœ°é•·ï¼ˆ24ç±³ï¼‰åŠé—Šï¼ˆ16ç±³ï¼‰çš„ï¼Ÿ
                </p>
                <div class="grid grid-cols-2 gap-3" id="quiz-step-1-choices">
                    <!-- JS ç”Ÿæˆé¸é … -->
                </div>
            </div>

            <div id="quiz-step-2" class="hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">åšå€‹ç²¾æ˜çš„è¾²å¤«ï¼</h2>
                <p class="text-lg text-gray-700 mb-6 text-center leading-relaxed">
                    é€™äº›è¾²ä½œç‰©éƒ½èƒ½å¤ é‹ªæ»¿è€•åœ°ï¼Œä½†å› ç‚ºäººæ‰‹ä¸è¶³ï¼Œ<br>æˆ‘æœƒé¸æ“‡é‚Šé•·æ˜¯______çš„è¾²ä½œç‰©ã€‚
                </p>
                <div class="grid grid-cols-2 gap-3" id="quiz-step-2-choices">
                    <!-- JS ç”Ÿæˆé¸é … -->
                </div>
                
                <!-- è€å¸«å°ˆç”¨æŒ‰éˆ•å€åŸŸ -->
                <div id="quiz-teacher-area" class="hidden mt-6 text-center animate-fade-in">
                    <button id="teacher-access-btn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition duration-300 text-lg shadow-lg animate-pulse">
                        è€å¸«å°ˆç”¨æŒ‰éˆ•
                    </button>
                </div>

                <!-- å¯†ç¢¼è¼¸å…¥å€åŸŸ -->
                <div id="step2-password-container" class="hidden mt-6 bg-gray-50 p-4 rounded-xl border-2 border-gray-200 text-center animate-fade-in">
                    <label class="block text-gray-600 font-bold mb-2">ğŸ”’ è«‹è¼¸å…¥é€šé—œå¯†ç¢¼</label>
                    <div class="flex gap-2 justify-center">
                        <input type="password" id="step2-pwd-input" placeholder="å¯†ç¢¼" 
                            class="border-2 border-gray-300 rounded-lg px-3 py-2 w-32 focus:outline-none focus:border-green-500 transition text-center"
                        >
                        <button id="step2-pwd-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                            ç¢ºèª
                        </button>
                    </div>
                    <p id="step2-pwd-error" class="text-red-500 text-sm font-bold mt-2 hidden">âŒ å¯†ç¢¼éŒ¯èª¤</p>
                </div>

                <!-- æ–°å¢ï¼šç¸½çµå€åŸŸ (å¯†ç¢¼æ­£ç¢ºå¾Œé¡¯ç¤º) -->
                <div id="quiz-conclusion-area" class="hidden mt-6 text-center animate-fade-in">
                    <div class="bg-green-50 p-4 rounded-xl border border-green-200 mb-4">
                        <div class="text-4xl mb-2">ğŸŒŸ</div>
                        <p class="text-lg text-gray-700 leading-relaxed">
                            <span class="font-bold text-blue-600 text-2xl">8</span> æ˜¯ 16 å’Œ 24 æœ€å¤§çš„å…±åŒå› æ•¸ï¼Œ<br>
                            æ‰€ä»¥ 8 æ˜¯ 16 å’Œ 24 çš„<br>
                            <span class="font-black text-red-500 text-xl">æœ€å¤§å…¬å› æ•¸ (H.C.F.)</span>ï¼
                        </p>
                    </div>
                    <button id="quiz-next-step-btn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition duration-300 text-lg shadow-lg animate-pulse">
                        å‰å¾€æŒ‘æˆ°èªªæ˜ â¡ï¸
                    </button>
                </div>
            </div>
            
            <p id="quiz-feedback-text" class="text-center font-bold mt-4 text-blue-600 text-lg leading-tight min-h-[3rem]"></p>
        </div>
    </div>

    <!-- è£œå›ï¼šHCF æ¦‚å¿µä»‹ç´¹å½ˆçª— -->
    <div id="hcf-intro-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-8 max-w-lg w-full shadow-2xl border-4 border-green-200 text-center">
            <div class="text-6xl mb-4">ğŸ“</div>
            <h2 class="text-2xl font-bold text-green-800 mb-4">ç²¾æ˜çš„è¾²å¤«</h2>
            <p class="text-xl text-gray-700 mb-8 leading-relaxed font-medium">
                ç”±æ–¼æˆ‘å€‘æ˜¯ç²¾æ˜çš„è¾²å¤«ï¼Œ<br>å°æ–¼æ¯ä¸€ç‰‡è€•åœ°ï¼Œæœƒé¸æ“‡<span class="text-red-600 font-bold">æœ€å¤§</span>çš„è¾²ä½œç‰©ã€‚<br>
                åœ¨æ•¸å­¸ä¸Šï¼Œ<br>æˆ‘å€‘ç¨±å®ƒç‚º<span class="text-blue-600 font-bold text-2xl">ã€Œæœ€å¤§å…¬å› æ•¸ã€</span>ã€‚
            </p>
            <button id="hcf-intro-confirm-btn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition duration-300 text-lg shadow-lg">
                æ˜ç™½äº†ï¼Œæº–å‚™æŒ‘æˆ°ï¼
            </button>
        </div>
    </div>

    <!-- æŒ‘æˆ°è³½é¸å–æœ€å¤§å…¬å› æ•¸å½ˆçª— (æ–°) -->
    <div id="challenge-hcf-select-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl border-4 border-blue-200">
            <h2 class="text-xl font-bold text-blue-800 mb-2 text-center">å…¨éƒ¨æ‰¾åˆ°äº†ï¼ğŸ‰</h2>
            <p class="text-gray-700 mb-4 text-center text-lg font-medium leading-relaxed">
                é€™äº›è¾²ä½œç‰©éƒ½èƒ½å¤ é‹ªæ»¿è€•åœ°ï¼Œ<br>ä½†å› ç‚ºäººæ‰‹ä¸è¶³ï¼Œ<br>æˆ‘æœƒé¸æ“‡é‚Šé•·æ˜¯______çš„è¾²ä½œç‰©ã€‚
            </p>
            <div id="challenge-hcf-choices" class="grid grid-cols-2 gap-3">
                <!-- JS ç”ŸæˆæŒ‰éˆ• -->
            </div>
        </div>
    </div>

    <!-- æŒ‘æˆ°è³½éé—œå½ˆçª— -->
    <div id="level-complete-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-6 max-w-sm w-full text-center shadow-2xl transform scale-100 border-4 border-green-200">
            <div class="text-5xl mb-3 animate-bounce">âœ¨</div>
            <h2 class="text-2xl font-bold text-green-700 mb-2">æ­£ç¢ºï¼</h2>
            <p class="text-gray-600 font-bold text-lg">+10 åˆ†</p>
            <p id="level-complete-msg" class="text-sm text-gray-500 mt-1"></p>
            <!-- æ‰‹å‹•ä¸‹ä¸€é—œæŒ‰éˆ• -->
            <button id="next-challenge-btn" class="mt-4 w-full bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition duration-300 flex items-center justify-center gap-2 text-lg shadow-lg">
                ä¸‹ä¸€é¡Œ â¡ï¸
            </button>
        </div>
    </div>
    
    <!-- æŒ‘æˆ°è³½å¤±æ•—/ç½°æ™‚å½ˆçª— -->
    <div id="level-fail-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-6 max-w-sm w-full text-center shadow-2xl border-4 border-red-200">
            <div class="text-5xl mb-3">âš ï¸</div>
            <h2 class="text-2xl font-bold text-red-700 mb-2">æŒ‘æˆ°å¤±æ•—ï¼</h2>
            <p class="text-red-500 font-bold mb-2">å…©æ¬¡æ©Ÿæœƒç”¨å®Œäº†...</p>
            <p id="fail-penalty-msg" class="text-red-600 font-bold text-xl mb-2"></p>
            <p class="text-gray-600 text-base">é€™é—œé‡æ–°é–‹å§‹ï¼</p>
            <button id="dismiss-fail-btn" class="mt-4 w-full bg-red-100 text-red-700 font-bold py-2 px-6 rounded-xl hover:bg-red-200 transition duration-300 text-lg">
                ç¹¼çºŒ
            </button>
        </div>
    </div>
    
    <!-- æŒ‘æˆ°è³½è­¦å‘Šå½ˆçª— (å‹•æ…‹é¡¯ç¤ºå‰©é¤˜æ©Ÿæœƒ) -->
    <div id="level-warn-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-6 max-w-xs w-full text-center shadow-2xl border-4 border-yellow-300">
            <div class="text-4xl mb-2">ğŸ’”</div>
            <h2 class="text-xl font-bold text-yellow-700 mb-1">ç­”æ¡ˆéŒ¯èª¤</h2>
            <!-- åŠ å…¥ ID ä»¥ä¾¿å‹•æ…‹æ›´æ–° -->
            <p id="warn-chances-text" class="text-gray-600 font-bold">é‚„å‰© ? æ¬¡æ©Ÿæœƒï¼</p>
            <button id="dismiss-warn-btn" class="mt-3 w-full bg-yellow-100 text-yellow-700 font-bold py-2 px-6 rounded-xl hover:bg-yellow-200 transition duration-300">
                å†è©¦ä¸€æ¬¡
            </button>
        </div>
    </div>

    <!-- æŒ‘æˆ°è³½çµæŸå½ˆçª— -->
    <div id="challenge-end-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="modal-content bg-white rounded-2xl p-6 max-w-2xl w-full text-center border-8 border-yellow-400 shadow-2xl my-8">
            <div class="text-6xl mb-2">ğŸ†</div>
            <h2 class="text-3xl font-bold text-yellow-800 mb-2">æŒ‘æˆ°çµæŸï¼</h2>
            <p id="end-reason" class="text-gray-600 mb-4 text-lg">æ™‚é–“åˆ°ï¼</p>
            
            <div class="bg-yellow-50 rounded-xl p-3 mb-4 border border-yellow-200 flex justify-center gap-8">
                <div>
                    <div class="text-xs text-gray-500 uppercase">æœ€çµ‚å¾—åˆ†</div>
                    <div class="text-4xl font-black text-blue-600"><span id="final-score">0</span></div>
                </div>
                <div>
                    <div class="text-xs text-gray-500 uppercase">å®Œæˆé¡Œæ•¸</div>
                    <div class="text-4xl font-black text-green-600"><span id="final-solved">0</span></div>
                </div>
            </div>

            <h3 class="text-left text-lg font-bold text-gray-700 mb-2">ğŸ“Š æŒ‘æˆ°ç´€éŒ„</h3>
            <div class="overflow-x-auto mb-6 rounded-lg border border-gray-200 max-h-60 overflow-y-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-700 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-center w-16">é—œæ•¸</th>
                            <th class="px-3 py-2">é¡Œç›® (é—Šxé•·)</th>
                            <th class="px-3 py-2">èƒ½å¤ é‹ªæ»¿è€•åœ°çš„è¾²ä½œç‰©(æ‰€æœ‰å…¬å› æ•¸)</th>
                            <th class="px-3 py-2 text-center">æ‰€é¸æ“‡çš„è¾²ä½œç‰©(æœ€å¤§å…¬å› æ•¸)</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="divide-y divide-gray-100">
                        <!-- JS å¡«å…¥ -->
                    </tbody>
                </table>
            </div>
            
            <button onclick="location.reload()" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl text-lg hover:bg-blue-700 transition duration-300 shadow-lg transform hover:scale-105">
                å†æ¬¡éŠç©
            </button>
        </div>
    </div>

    <script>
        // --- éŠæˆ²è³‡æ–™ ---
        const tutorialLevel = {
            width: 16,
            length: 24,
            maxToolSize: 16,
            title: "è€•åœ°é‚Šé•·ï¼š 16ç±³ (é—Š) Ã— 24ç±³ (é•·)" 
        };

        // æŒ‡å®šçš„æŒ‘æˆ°é—œå¡
        const challengeLevels = [
            { w: 2, l: 4 },   // ç¬¬1é¡Œ (æ›´æ–°)
            { w: 5, l: 10 },  // ç¬¬2é¡Œ (æ›´æ–°)
            { w: 6, l: 8 },   // ç¬¬3é¡Œ
            { w: 6, l: 12 },  // ç¬¬4é¡Œ
            { w: 12, l: 20 }, // ç¬¬5é¡Œ
            { w: 10, l: 20 }, // ç¬¬6é¡Œ
            { w: 14, l: 28 }, // ç¬¬7é¡Œ
            { w: 12, l: 24 }, // ç¬¬8é¡Œ (é–‹å§‹æ‰‹å‹•)
            { w: 20, l: 30 }, // ç¬¬9é¡Œ (æ›´æ–°)
            { w: 18, l: 45 }  // ç¬¬10é¡Œ (æ›´æ–°)
        ];

        // --- ç‹€æ…‹è®Šæ•¸ ---
        let currentFarm;
        let testedSizes = {};
        let lives = 2; 
        let totalCorrectFactors = 0;
        let correctFactorsFound = [];
        let gameOver = false;
        
        let lastTestedSize = null;
        let lastErrorWasHCFSelection = false; // æ–°å¢ï¼šè¿½è¹¤æœ€å¾Œä¸€æ¬¡éŒ¯èª¤é¡å‹

        // æŒ‘æˆ°è³½è®Šæ•¸
        let isChallengeMode = false;
        let currentChallengeIndex = 0;
        let score = 0;
        let timerInterval;
        let timeLeft = 300; // 5åˆ†é˜
        let challengeHistory = []; // è¨˜éŒ„æ¯ä¸€é—œçš„æ•¸æ“š {level, title, commonFactors, hcf}
        let currentLevelFails = 0; // ç¸½å¤±æ•—é—œå¡æ•¸ (ç”¨æ–¼è¨ˆç®—ç½°æ™‚)
        let currentLevelLives = 2; // ç•¶å‰é—œå¡å‰©é¤˜ç”Ÿå‘½

        // --- DOM å…ƒç´  ---
        const farmGridContainer = document.getElementById('farm-grid-container');
        const farmerMessageEl = document.getElementById('farmer-message');
        const resultsBodyEl = document.getElementById('results-body');
        const completeTutorialBtn = document.getElementById('complete-tutorial-btn');
        const retryButton = document.getElementById('retry-button');
        const summaryButton = document.getElementById('summary-button'); 
        const nextLevelButton = document.getElementById('next-level-button');
        const headerLevelTitle = document.getElementById('header-level-title'); 
        const mobileLevelTitle = document.getElementById('mobile-level-title'); 
        const livesDisplay = document.getElementById('lives-display');
        const farmLabelWidth = document.getElementById('farm-label-width');
        const farmLabelLength = document.getElementById('farm-label-length');
        const mainGameArea = document.getElementById('main-game-area');
        
        // Start Challenge Button
        const startChallengeContainer = document.getElementById('start-challenge-container');
        const startChallengeBtn = document.getElementById('start-challenge-btn');

        // å·¥å…·ç®±
        const toolboxContainer = document.getElementById('toolbox-container');
        const toolBoxEl = document.getElementById('toolbox');
        const manualInputContainer = document.getElementById('manual-input-container');
        const manualSizeInput = document.getElementById('manual-size-input');
        const manualTestBtn = document.getElementById('manual-test-btn');
        const manualHistory = document.getElementById('manual-history');

        // Modal & Headers
        const hcfQuizModal = document.getElementById('hcf-quiz-modal');
        const quizStep1 = document.getElementById('quiz-step-1');
        const quizStep2 = document.getElementById('quiz-step-2');
        const quizStep3 = document.getElementById('quiz-step-3');
        const quizFeedbackText = document.getElementById('quiz-feedback-text');
        
        // æŒ‘æˆ°è³½å°ˆç”¨
        const challengeHeader = document.getElementById('challenge-header');
        const timerDisplay = document.getElementById('timer-display');
        const scoreDisplay = document.getElementById('score-display');
        const levelIndicator = document.getElementById('level-indicator');
        const progressBar = document.getElementById('challenge-progress-bar');
        const levelCompleteModal = document.getElementById('level-complete-modal');
        const nextChallengeBtn = document.getElementById('next-challenge-btn'); 
        const levelFailModal = document.getElementById('level-fail-modal');
        const failPenaltyMsg = document.getElementById('fail-penalty-msg');
        const dismissFailBtn = document.getElementById('dismiss-fail-btn');
        const challengeEndModal = document.getElementById('challenge-end-modal');
        const levelWarnModal = document.getElementById('level-warn-modal');
        const dismissWarnBtn = document.getElementById('dismiss-warn-btn');
        const finalScoreEl = document.getElementById('final-score');
        const finalSolvedEl = document.getElementById('final-solved');
        const endReasonEl = document.getElementById('end-reason');
        const historyTableBody = document.getElementById('history-table-body');
        
        // HCF Select Modal
        const challengeHcfSelectModal = document.getElementById('challenge-hcf-select-modal');
        const challengeHcfChoices = document.getElementById('challenge-hcf-choices');

        // --- æ ¸å¿ƒè¼”åŠ©å‡½æ•¸ ---
        
        function getFactors(num) {
            const factors = [];
            for (let i = 1; i <= num; i++) {
                if (num % i === 0) factors.push(i);
            }
            return factors;
        }

        function getCommonFactors(num1, num2) {
            const factors1 = getFactors(num1);
            const factors2 = getFactors(num2);
            return factors1.filter(f => factors2.includes(f));
        }

        function getHCF(num1, num2) {
            const common = getCommonFactors(num1, num2);
            return Math.max(...common);
        }
        
        function showModal(modalElement) {
            if (modalElement) {
                modalElement.classList.remove('hidden');
                const content = modalElement.querySelector('.modal-content');
                if (content) setTimeout(() => content.classList.add('show'), 10);
            }
        }

        function hideModal(modalElement) {
            if (modalElement) {
                const content = modalElement.querySelector('.modal-content');
                if (content) {
                    content.classList.remove('show');
                    setTimeout(() => modalElement.classList.add('hidden'), 300);
                } else {
                    modalElement.classList.add('hidden');
                }
            }
        }
        
        function updateLivesDisplay() {
            if (isChallengeMode) {
                // åœ¨æŒ‘æˆ°æ¨¡å¼é¡¯ç¤ºå¿ƒå¿ƒ
                livesDisplay.innerHTML = 'â¤ï¸'.repeat(currentLevelLives) + 'ğŸ’”'.repeat(2 - currentLevelLives);
            } else {
                livesDisplay.innerHTML = '';
            }
        }

        function updateFarmerMessage(size, fitsWidth, fitsLength, fitsAll) {
            let msg = '';
            if (farmerMessageEl) {
                farmerMessageEl.classList.remove('border-red-500', 'border-green-500', 'border-yellow-500', 'border-blue-500');
                
                if (isChallengeMode) {
                    // æŒ‘æˆ°æ¨¡å¼çš„è¨Šæ¯
                     if (fitsAll) {
                        msg = `${size}ç±³ å¯ä»¥é‹ªæ»¿ï¼ç¹¼çºŒå°‹æ‰¾å…¶ä»–å…¬å› æ•¸...`;
                        farmerMessageEl.classList.add('border-green-500');
                     } else {
                        msg = `${size}ç±³ ä¸èƒ½é‹ªæ»¿ã€‚é‚„å‰© <span class="font-bold text-red-600">${currentLevelLives}</span> æ¬¡æ©Ÿæœƒï¼`;
                        farmerMessageEl.classList.add('border-red-500');
                     }
                } else {
                    // æ•™å­¸æ¨¡å¼çš„è¨Šæ¯
                    if (fitsAll) {
                        msg = `å¤ªæ£’äº†ï¼${size}ç±³ å‰›å¥½å¯ä»¥é‹ªæ»¿é€™å¡Šè€•åœ°ï¼å®ƒæ˜¯ ${currentFarm.width} å’Œ ${currentFarm.length} çš„å…¬å› æ•¸ã€‚`;
                        farmerMessageEl.classList.add('border-green-500');
                    } else if (fitsWidth || fitsLength) {
                        let fits = fitsWidth ? 'é—Šåº¦' : 'é•·åº¦';
                        let fails = fitsWidth ? 'é•·åº¦' : 'é—Šåº¦';
                        msg = `${size}ç±³ å¯ä»¥é‹ªæ»¿ ${fits}ï¼Œä½†åœ¨ ${fails} æœƒå‰©ä¸‹ç©ºä½ã€‚é€™ä¸æ˜¯å…¬å› æ•¸ã€‚`;
                        farmerMessageEl.classList.add('border-yellow-500');
                    } else {
                        msg = `å¯æƒœï¼Œ${size}ç±³ åœ¨é—Šåº¦å’Œé•·åº¦éƒ½æœƒå‰©ä¸‹ç©ºä½ã€‚è«‹å†è©¦è©¦å…¶ä»–å°ºå¯¸ã€‚`;
                        farmerMessageEl.classList.add('border-red-500');
                    }
                }
                farmerMessageEl.innerHTML = msg;
            }
        }

        function updateTable(size, fitsWidth, fitsLength, fitsAll) {
            const row = document.getElementById(`result-row-${size}`);
            if (!row) return;

            const widthEl = document.getElementById(`width-fit-${size}`);
            const lengthEl = document.getElementById(`length-fit-${size}`);
            const allEl = document.getElementById(`all-fit-${size}`);

            const checkmark = '<span class="text-green-600 text-base md:text-lg">âœ…</span>';
            const cross = '<span class="text-red-600 text-base md:text-lg">âŒ</span>';
            
            // ç§»é™¤ whitespace-nowrapï¼Œå…è¨±æ›è¡Œï¼Œå¢åŠ  padding
            const baseClass = "py-3 px-1 font-bold border-b border-blue-50";

            if (widthEl) {
                widthEl.innerHTML = fitsWidth ? checkmark : cross;
                widthEl.className = `${baseClass}`;
            }
            if (lengthEl) {
                lengthEl.innerHTML = fitsLength ? checkmark : cross;
                lengthEl.className = `${baseClass}`;
            }
            if (allEl) {
                allEl.innerHTML = fitsAll ? checkmark : cross;
                allEl.className = `${baseClass} ${fitsAll ? 'bg-green-50' : ''}`;
            }
        }

        function visualizeTest(size, fitsWidth, fitsLength, widthRemainder, lengthRemainder) {
            if (!farmGridContainer) return;
            
            farmGridContainer.innerHTML = '';
            
            const unitWidthPercent = 100 / currentFarm.width;
            const unitHeightPercent = 100 / currentFarm.length;
            
            const numTilesX = Math.floor(currentFarm.width / size);
            const numTilesY = Math.floor(currentFarm.length / size);
            
            // è¨ˆç®—ç¸½æ ¼å­æ•¸
            const totalTiles = numTilesX * numTilesY;

            // æ•ˆèƒ½å„ªåŒ–ï¼šå¦‚æœæ ¼å­å¤ªå¤š (>1500)ï¼Œåªæ¸²æŸ“ç–ŠåŠ å±¤ï¼Œä¸æ¸²æŸ“æ¯å€‹ div
            if (totalTiles > 1500) {
                 const div = document.createElement('div');
                 div.className = 'absolute inset-0 flex items-center justify-center text-4xl font-bold opacity-50 bg-green-200';
                 div.innerHTML = fitsWidth && fitsLength ? 'ğŸŒ±' : '';
                 farmGridContainer.appendChild(div);
                 return; // é‡è¦ï¼šå¦‚æœå„ªåŒ–ï¼Œç›´æ¥è¿”å›ï¼Œä¸å†æ¸²æŸ“å–®ç¨çš„æ ¼å­
            } 

            // æ±ºå®šæ˜¯å¦é¡¯ç¤ºå°æ ¼å­çš„æ–‡å­—å’Œé‚Šæ¡†
            const isSmallTile = (size * unitWidthPercent < 5) || (size * unitHeightPercent < 5);
            // æ±ºå®šæ˜¯å¦ä½¿ç”¨å‹•ç•« (æ ¼å­å¤šæ™‚ç¦ç”¨å‹•ç•«ä»¥æé«˜æ•ˆèƒ½)
            const useAnimation = totalTiles < 400;

            for (let x = 0; x < numTilesX; x++) {
                for (let y = 0; y < numTilesY; y++) {
                    const div = document.createElement('div');
                    div.className = `tile-base plant-tile ${isSmallTile ? 'small-tile' : ''} ${useAnimation ? 'animate-fade-in' : ''}`;
                    
                    // å¼·åˆ¶é¡¯ç¤ºæ•¸å­—ï¼Œå³ä½¿æ˜¯å°æ ¼å­ (åªè¦æ ¼å­ä¸æ˜¯æ¥µåº¦å°åˆ°ç„¡æ³•é¡¯ç¤º)
                    // ä½¿ç”¨ clamp å’Œ overflow: hidden ä¾†æ§åˆ¶
                    div.textContent = `${size}`;
                    
                    const xPos = x * size * unitWidthPercent;
                    const yPos = y * size * unitHeightPercent;
                    const w = size * unitWidthPercent;
                    const h = size * unitHeightPercent;
                    
                    div.style.setProperty('--tile-x', `${xPos}%`);
                    div.style.setProperty('--tile-y', `${yPos}%`);
                    div.style.setProperty('--tile-width', `${w}%`);
                    div.style.setProperty('--tile-height', `${h}%`);
                    
                    // å¦‚æœä½¿ç”¨å‹•ç•«ï¼Œå¯ä»¥åŠ å…¥å»¶é²
                    if (useAnimation) {
                        div.style.animationDelay = `${(x + y) * 10}ms`;
                    }
                    
                    farmGridContainer.appendChild(div);
                }
            }

            if (widthRemainder > 0) {
                const gapDiv = document.createElement('div');
                gapDiv.className = 'tile-base gap-tile';
                gapDiv.textContent = `å‰©${widthRemainder}`;
                
                const xPos = numTilesX * size * unitWidthPercent;
                const yPos = 0;
                const w = widthRemainder * unitWidthPercent;
                const h = 100;
                
                gapDiv.style.setProperty('--tile-x', `${xPos}%`);
                gapDiv.style.setProperty('--tile-y', `${yPos}%`);
                gapDiv.style.setProperty('--tile-width', `${w}%`);
                gapDiv.style.setProperty('--tile-height', `${h}%`);
                farmGridContainer.appendChild(gapDiv);
            }
            
            if (lengthRemainder > 0) {
                const gapDiv = document.createElement('div');
                gapDiv.className = 'tile-base gap-tile';
                gapDiv.textContent = `å‰©${lengthRemainder}`;
                
                const xPos = 0;
                const yPos = numTilesY * size * unitHeightPercent;
                const w = (currentFarm.width - (widthRemainder > 0 ? widthRemainder : 0)) * unitWidthPercent; 
                const h = lengthRemainder * unitHeightPercent;
                
                gapDiv.style.setProperty('--tile-x', `${xPos}%`);
                gapDiv.style.setProperty('--tile-y', `${yPos}%`);
                gapDiv.style.setProperty('--tile-width', `${w}%`);
                gapDiv.style.setProperty('--tile-height', `${h}%`);
                farmGridContainer.appendChild(gapDiv);
            }
        }

        // --- æ ¸å¿ƒé‚è¼¯: æª¢æŸ¥æ˜¯å¦éé—œ ---
        function checkLevelCompletion(clickedSize) {
            // æ•™å­¸é—œé‚è¼¯
            if (!isChallengeMode) {
                const commonFactors = getCommonFactors(currentFarm.width, currentFarm.length);
                const requiredFactors = commonFactors.filter(f => f <= currentFarm.maxToolSize || testedSizes[f]); 
                totalCorrectFactors = requiredFactors.length;
                correctFactorsFound = requiredFactors.filter(f => testedSizes[f]);

                if (correctFactorsFound.length === totalCorrectFactors) {
                    setTimeout(startHCFQuiz, 1000);
                }
                return;
            }

            // æŒ‘æˆ°é—œé‚è¼¯ï¼š(ç”± testSize è§¸ç™¼ï¼Œé€™è£¡ä¸»è¦è™•ç†ç•¶æ‰¾é½Šæ‰€æœ‰å› æ•¸æ™‚)
            const commonFactors = getCommonFactors(currentFarm.width, currentFarm.length);
            
            // å¦‚æœæ‰€æœ‰å…¬å› æ•¸éƒ½æ‰¾åˆ°äº†
            if (correctFactorsFound.length === commonFactors.length) {
                showChallengeHCFSelect();
            }
        }
        
        function showChallengeHCFSelect() {
            challengeHcfChoices.innerHTML = '';
            // æ’åºå¾å°åˆ°å¤§
            correctFactorsFound.sort((a, b) => a - b).forEach(factor => {
                const btn = document.createElement('button');
                btn.className = "bg-blue-100 hover:bg-blue-200 text-blue-800 font-bold py-3 px-4 rounded-xl transition text-lg";
                btn.textContent = `${factor}ç±³`;
                btn.onclick = () => handleHCFSelection(factor);
                challengeHcfChoices.appendChild(btn);
            });
            showModal(challengeHcfSelectModal);
        }

        function handleHCFSelection(selected) {
            const hcf = getHCF(currentFarm.width, currentFarm.length);
            hideModal(challengeHcfSelectModal);
            
            if (selected === hcf) {
                handleChallengeSuccess(hcf);
            } else {
                handleWrongAnswer(selected, true); // true indicates HCF selection error
            }
        }

        // --- éŠæˆ²æµç¨‹ (æ•™å­¸é—œ) ---

        function initGame() {
            isChallengeMode = false;
            currentRetryCount = 0;
            loadLevelData(tutorialLevel);
            if (startChallengeBtn) {
                startChallengeBtn.addEventListener('click', startChallengeMode);
            }
        }
        
        function loadLevelData(levelData) {
            currentFarm = levelData;
            testedSizes = {};
            gameOver = false;
            lives = 2; 
            correctFactorsFound = [];
            lastTestedSize = null;
            currentErrorsMade = 0;
            lastErrorWasHCFSelection = false; // é‡ç½®éŒ¯èª¤ç‹€æ…‹
            
            // è¨ˆç®—éœ€è¦æ‰¾åˆ°çš„å…¬å› æ•¸ç¸½æ•¸
            totalCorrectFactors = getCommonFactors(currentFarm.width, currentFarm.length)
                                    .filter(f => f <= currentFarm.maxToolSize)
                                    .length;

            if (headerLevelTitle) headerLevelTitle.textContent = currentFarm.title;
            if (mobileLevelTitle) mobileLevelTitle.textContent = currentFarm.title;
            
            if (farmLabelWidth) farmLabelWidth.textContent = `é—Šåº¦: ${currentFarm.width}ç±³`;
            if (farmLabelLength) farmLabelLength.textContent = `é•·åº¦: ${currentFarm.length}ç±³`;
            
            if (farmGridContainer) {
                farmGridContainer.style.setProperty('--aspect-ratio-val', `${currentFarm.width} / ${currentFarm.length}`);
                farmGridContainer.innerHTML = '';
            }

            // å®‰å…¨åœ°è™•ç†æŒ‰éˆ•éš±è—
            if (summaryButton) summaryButton.classList.add('hidden');
            if (retryButton) retryButton.classList.add('hidden');
            if (completeTutorialBtn) completeTutorialBtn.classList.add('hidden'); 
            
            if (resultsBodyEl) resultsBodyEl.innerHTML = '';

            // åˆ¤æ–·æ˜¯å¦ç‚ºæŒ‘æˆ°æ¨¡å¼çš„ç¬¬8-10é¡Œ
            const isManualMode = isChallengeMode && currentChallengeIndex >= 7;

            // æ•™å­¸é—œè¨­å®š / æŒ‘æˆ°é—œè¨­å®š
            if (!isManualMode) {
                setupButtonGrid(); // 1-7é¡Œä½¿ç”¨æŒ‰éˆ•
                if (toolboxContainer) toolboxContainer.classList.remove('hidden');
                if (manualInputContainer) manualInputContainer.classList.add('hidden');
            } else {
                setupManualInput(); // 8-10é¡Œä½¿ç”¨æ‰‹å‹•è¼¸å…¥
                if (toolboxContainer) toolboxContainer.classList.add('hidden');
                if (manualInputContainer) manualInputContainer.classList.remove('hidden');
            }

            if (isChallengeMode) {
                if (farmerMessageEl) farmerMessageEl.innerHTML = `æŒ‘æˆ°ï¼šè«‹æ‰¾å‡ºé€™å¡Š ${currentFarm.width}x${currentFarm.length} è€•åœ°çš„<span class="text-red-600 font-bold">æ‰€æœ‰å…¬å› æ•¸</span>ï¼`;
                if (toolboxContainer) toolboxContainer.classList.remove('review-enabled');
            } else {
                if (farmerMessageEl) farmerMessageEl.innerHTML = 'è«‹åœ¨å³é‚Šçš„ã€Œè¾²ä½œç‰©å·¥å…·ç®±ã€é¸æ“‡ä¸€æ¬¾æ­£æ–¹å½¢è¾²ä½œç‰©è©¦è©¦çœ‹å§ï¼';
                if (toolboxContainer) toolboxContainer.classList.add('review-enabled');
            }
            
            if (farmerMessageEl) {
                farmerMessageEl.className = 'flex-none w-full bg-white/95 backdrop-blur-sm border-l-8 border-yellow-500 text-yellow-900 p-3 rounded-xl shadow-lg z-30 transition-all duration-300 min-h-[60px] flex items-center text-sm md:text-base font-medium mb-2';
                farmerMessageEl.classList.remove('hidden');
            }
        }

        function setupButtonGrid() {
            if (!toolBoxEl) return;
            toolBoxEl.innerHTML = '';
            // å¦‚æœæ˜¯æŒ‘æˆ°æ¨¡å¼ï¼Œç¢ºä¿æœ€å¤§å…¬å› æ•¸åœ¨æŒ‰éˆ•è£¡
            const hcf = getHCF(currentFarm.width, currentFarm.length);
            
            // æ ¹æ“šä¸åŒé›£åº¦ï¼Œé¡¯ç¤ºä¸åŒæ•¸é‡çš„æŒ‰éˆ•
            let limit;
            if (isChallengeMode) {
                // 1-7é¡Œï¼ŒæŒ‰éˆ•æ•¸é‡è¶³å¤ è¦†è“‹ HCF
                // å¯ä»¥ç¨å¾®çµ¦å¤šä¸€é»å¹²æ“¾é …
                limit = Math.max(12, hcf + 2);
            } else {
                limit = 12; // æ•™å­¸é—œå›ºå®š
            }
            
            for (let i = 1; i <= limit; i++) {
                const button = document.createElement('button');
                button.textContent = `${i}ç±³`;
                button.dataset.size = i;
                button.className = 'tool-btn w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-3 px-2 rounded-lg shadow-md';
                button.addEventListener('click', () => testSize(i));
                toolBoxEl.appendChild(button);
                
                // é å…ˆå»ºç«‹è¡¨æ ¼è¡Œ (åƒ…æ•™å­¸æ¨¡å¼)
                if (!isChallengeMode) addResultRow(i);
            }
        }

        function setupManualInput() {
            if (!manualSizeInput || !manualHistory) return;
            manualSizeInput.value = '';
            manualHistory.innerHTML = '';
            manualSizeInput.disabled = false;
            manualTestBtn.disabled = false;
        }

        // æ‰‹å‹•è¼¸å…¥äº‹ä»¶ç¶å®š
        if (manualTestBtn) {
            manualTestBtn.addEventListener('click', () => {
                const val = parseInt(manualSizeInput.value);
                if (!val || val <= 0) return;
                
                // å¦‚æœè©²å°ºå¯¸æœªæ¸¬è©¦éï¼Œå‰‡æ–°å¢è¡Œä¸¦æ¸¬è©¦
                if (!document.getElementById(`result-row-${val}`)) {
                    addResultRow(val);
                }
                
                testSize(val);
                manualSizeInput.value = '';
                manualSizeInput.focus();
            });
        }

        if (manualSizeInput) {
            manualSizeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') manualTestBtn.click();
            });
        }

        function addResultRow(size) {
            if (document.getElementById(`result-row-${size}`)) return;
            if (!resultsBodyEl) return;
            const row = document.createElement('tr');
            row.id = `result-row-${size}`;
            row.className = 'hover:bg-blue-50 transition-colors';
            // ç§»é™¤ whitespace-nowrap
            row.innerHTML = `
                <td class="py-3 px-1 font-bold border-b border-blue-50">${size}ç±³</td>
                <td id="width-fit-${size}" class="py-3 px-1 border-b border-blue-50 text-gray-400">?</td>
                <td id="length-fit-${size}" class="py-3 px-1 border-b border-blue-50 text-gray-400">?</td>
                <td id="all-fit-${size}" class="py-3 px-1 border-b border-blue-50 text-gray-400">?</td>
            `;
            resultsBodyEl.appendChild(row);
            row.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function testSize(size) {
            if (gameOver) return; 

            // åœ¨ä»»ä½•æ¨¡å¼ä¸‹ï¼Œå¦‚æœè¡¨æ ¼è¡Œä¸å­˜åœ¨ï¼Œéƒ½è¦å‰µå»º (ç¢ºä¿æŒ‘æˆ°æ¨¡å¼æœ‰è¨˜éŒ„)
            if (!document.getElementById(`result-row-${size}`)) {
                addResultRow(size);
            }

            // æŒ‘æˆ°æ¨¡å¼é‚è¼¯
            if (isChallengeMode) {
                // å¦‚æœå·²ç¶“é»éï¼Œä¸é‡è¤‡è™•ç†
                if (testedSizes[size]) return;

                lastTestedSize = size;
                const widthRemainder = currentFarm.width % size;
                const lengthRemainder = currentFarm.length % size;
                const fitsAll = widthRemainder === 0 && lengthRemainder === 0;
                
                visualizeTest(size, widthRemainder === 0, lengthRemainder === 0, widthRemainder, lengthRemainder);
                updateTable(size, widthRemainder === 0, lengthRemainder === 0, fitsAll); // ç¢ºä¿è¡¨æ ¼æ›´æ–°

                testedSizes[size] = true;
                const button = toolBoxEl.querySelector(`[data-size="${size}"]`);
                if(button) button.classList.add('tested');
                
                // è¨˜éŒ„æ‰‹å‹•è¼¸å…¥æ­·å² (å¦‚æœåœ¨æ‰‹å‹•æ¨¡å¼)
                if (currentChallengeIndex >= 7 && manualHistory) {
                    const badge = document.createElement('span');
                    badge.className = `px-2 py-1 rounded text-sm font-bold border ${fitsAll ? 'bg-green-100 text-green-700 border-green-300' : 'bg-red-100 text-red-700 border-red-300'}`;
                    badge.textContent = `${size}ç±³ ${fitsAll ? 'âœ…' : 'âŒ'}`;
                    manualHistory.appendChild(badge);
                    manualHistory.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }

                if (fitsAll) {
                    // æ˜¯å…¬å› æ•¸ -> æ¨™è¨˜ç‚ºæ‰¾åˆ°
                    if (!correctFactorsFound.includes(size)) {
                        correctFactorsFound.push(size);
                    }
                    updateFarmerMessage(size, true, true, true);
                    checkLevelCompletion(size);
                } else {
                    // ä¸æ˜¯å…¬å› æ•¸ -> éŒ¯èª¤
                    handleWrongAnswer(size, false);
                }
                return;
            }

            // æ•™å­¸æ¨¡å¼ï¼šæ™®é€šé‚è¼¯
            if (testedSizes[size]) {
                lastTestedSize = size;
                const widthRemainder = currentFarm.width % size;
                const lengthRemainder = currentFarm.length % size;
                visualizeTest(size, widthRemainder === 0, lengthRemainder === 0, widthRemainder, lengthRemainder);
                updateFarmerMessage(size, widthRemainder === 0, lengthRemainder === 0, widthRemainder === 0 && lengthRemainder === 0);
                return; 
            }
            
            lastTestedSize = size;
            const widthRemainder = currentFarm.width % size;
            const lengthRemainder = currentFarm.length % size;
            const fitsAll = widthRemainder === 0 && lengthRemainder === 0;

            const button = toolBoxEl.querySelector(`[data-size="${size}"]`);
            if(button) button.classList.add('tested');
            
            testedSizes[size] = true;

            visualizeTest(size, widthRemainder === 0, lengthRemainder === 0, widthRemainder, lengthRemainder);
            updateTable(size, widthRemainder === 0, lengthRemainder === 0, fitsAll);
            updateFarmerMessage(size, widthRemainder === 0, lengthRemainder === 0, fitsAll);
            
            if (fitsAll) {
                if (!correctFactorsFound.includes(size)) {
                    correctFactorsFound.push(size);
                }
                checkLevelCompletion(size); 
            }
        } 
        
        // --- HCF æ¸¬é©—é‚è¼¯ (æ•™å­¸é—œå®Œæˆå¾Œ) ---
        function renderQuizStep2() {
            const choices2 = [1, 2, 4, 8];
            const container = document.getElementById('quiz-step-2-choices');
            const teacherArea = document.getElementById('quiz-teacher-area');
            const pwdContainer = document.getElementById('step2-password-container');
            const conclusionArea = document.getElementById('quiz-conclusion-area'); // å–å¾—ç¸½çµå€åŸŸ
            const pwdInput = document.getElementById('step2-pwd-input');
            const pwdError = document.getElementById('step2-pwd-error');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            // é‡ç½®ç‹€æ…‹
            if (teacherArea) teacherArea.classList.add('hidden');
            if (pwdContainer) pwdContainer.classList.add('hidden');
            if (conclusionArea) conclusionArea.classList.add('hidden'); // é‡ç½®ç¸½çµéš±è—
            if (pwdInput) pwdInput.value = '';
            if (pwdError) pwdError.classList.add('hidden');
            if (quizFeedbackText) quizFeedbackText.textContent = "";

            choices2.forEach(c => {
                const btn = document.createElement('button');
                btn.textContent = `${c}ç±³`;
                btn.className = "bg-yellow-100 hover:bg-yellow-200 text-yellow-800 font-bold py-3 px-4 rounded-xl transition duration-200";
                btn.onclick = () => {
                    // 1. é–å®šæ‰€æœ‰æŒ‰éˆ• (Disable all)
                    Array.from(container.children).forEach(child => {
                        child.disabled = true; // ç¦ç”¨æŒ‰éˆ•
                        if (child !== btn) {
                            child.className = "bg-gray-100 text-gray-400 font-bold py-3 px-4 rounded-xl transition duration-200 opacity-50 cursor-not-allowed";
                        }
                    });
                    
                    // 2. é«˜äº®ç•¶å‰æŒ‰éˆ•
                    btn.className = "bg-blue-100 text-blue-900 font-bold py-3 px-4 rounded-xl border-2 border-blue-500 scale-105 shadow-md cursor-not-allowed";

                    // 3. é¡¯ç¤ºæç¤ºæ–‡å­—
                    if (quizFeedbackText) {
                        quizFeedbackText.textContent = "ç‚ºä»€éº¼?è«‹å°‡ä½ çš„ç­”æ¡ˆå¯«åœ¨å·¥ä½œç´™ç¬¬ 5 é ,ç„¶å¾Œèˆ‰æ‰‹å‘Šè¨´è€å¸«ã€‚";
                        quizFeedbackText.className = "text-center font-bold mt-4 text-blue-600 text-lg leading-tight";
                    }
                    
                    // 4. ç„¡è«–é¸å°é¸éŒ¯ï¼Œéƒ½é¡¯ç¤ºè€å¸«æŒ‰éˆ• (ä¿®æ­£é»)
                    if (teacherArea) {
                        teacherArea.classList.remove('hidden');
                        setTimeout(() => teacherArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
                    }
                };
                container.appendChild(btn);
            });
        }

        // ç¶å®šè€å¸«æŒ‰éˆ•èˆ‡å¯†ç¢¼é©—è­‰
        const teacherAccessBtn = document.getElementById('teacher-access-btn');
        const step2PwdBtn = document.getElementById('step2-pwd-btn');
        const quizNextStepBtn = document.getElementById('quiz-next-step-btn'); // æ–°å¢æŒ‰éˆ•ç¶å®š
        
        if (teacherAccessBtn) {
            teacherAccessBtn.addEventListener('click', () => {
                const teacherArea = document.getElementById('quiz-teacher-area');
                const pwdContainer = document.getElementById('step2-password-container');
                
                if (teacherArea) teacherArea.classList.add('hidden');
                if (pwdContainer) {
                    pwdContainer.classList.remove('hidden');
                    setTimeout(() => pwdContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
                }
            });
        }

        if (step2PwdBtn) {
            step2PwdBtn.addEventListener('click', () => {
                const pwdInput = document.getElementById('step2-pwd-input');
                const pwdError = document.getElementById('step2-pwd-error');
                const pwdContainer = document.getElementById('step2-password-container');
                const conclusionArea = document.getElementById('quiz-conclusion-area');

                if (pwdInput.value === 'hcfhcf') {
                    // å¯†ç¢¼æ­£ç¢º -> é¡¯ç¤ºç¸½çµ
                    if (pwdError) pwdError.classList.add('hidden');
                    if (pwdContainer) pwdContainer.classList.add('hidden'); // éš±è—å¯†ç¢¼æ¡†
                    if (conclusionArea) {
                        conclusionArea.classList.remove('hidden'); // é¡¯ç¤ºç¸½çµ
                        setTimeout(() => conclusionArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
                    }
                } else {
                    // å¯†ç¢¼éŒ¯èª¤
                    if (pwdError) pwdError.classList.remove('hidden');
                    pwdInput.value = '';
                    pwdInput.focus();
                }
            });
        }

        // æ–°å¢ï¼šç¸½çµé é¢çš„ã€Œå‰å¾€æŒ‘æˆ°èªªæ˜ã€æŒ‰éˆ•
        if (quizNextStepBtn) {
            quizNextStepBtn.addEventListener('click', () => {
                hideModal(hcfQuizModal);
                showModal(document.getElementById('hcf-intro-modal'));
            });
        }
        
        // HCF Intro ç¢ºèªæŒ‰éˆ•
        const hcfIntroConfirmBtn = document.getElementById('hcf-intro-confirm-btn');
        if (hcfIntroConfirmBtn) {
            hcfIntroConfirmBtn.addEventListener('click', () => {
                hideModal(document.getElementById('hcf-intro-modal'));
                
                // é¡¯ç¤ºã€Œé–‹å§‹æŒ‘æˆ°ã€æŒ‰éˆ•ï¼Œä¸¦å…è¨±è‡ªç”±è¦†æŸ¥
                if (startChallengeContainer) startChallengeContainer.classList.remove('hidden');
                
                if (farmerMessageEl) {
                    farmerMessageEl.innerHTML = 'ç¾åœ¨ä½ å¯ä»¥è‡ªç”±è¦†æŸ¥ï¼Œæº–å‚™å¥½å¾ŒæŒ‰ä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æŒ‘æˆ°ï¼';
                    farmerMessageEl.classList.add('bg-blue-100', 'border-blue-500');
                }
            });
        }

        function startHCFQuiz() {
            showModal(hcfQuizModal);
            if (quizStep1) quizStep1.classList.remove('hidden');
            if (quizStep2) quizStep2.classList.add('hidden');
            // quizStep3 removed
            
            // æ¸²æŸ“æ­¥é©Ÿ1é¸é …
            const choices1 = ["å› æ•¸", "å…¬å› æ•¸", "å€æ•¸", "åˆæˆæ•¸", "è³ªæ•¸"];
            renderQuizChoices('quiz-step-1-choices', choices1, 'å…¬å› æ•¸', () => {
                if (quizStep1) quizStep1.classList.add('hidden');
                if (quizStep2) quizStep2.classList.remove('hidden');
                renderQuizStep2();
            });
            if (quizFeedbackText) quizFeedbackText.textContent = "";
            // Ensure conclusion is hidden initially
            const conclusionArea = document.getElementById('quiz-conclusion-area');
            if (conclusionArea) conclusionArea.classList.add('hidden');
        }

        function renderQuizChoices(containerId, choices, correctAnswer, onSuccess) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            choices.forEach(c => {
                const btn = document.createElement('button');
                btn.textContent = typeof c === 'number' ? `${c}ç±³` : c;
                btn.className = "bg-yellow-100 hover:bg-yellow-200 text-yellow-800 font-bold py-3 px-4 rounded-xl transition duration-200";
                btn.onclick = () => {
                    if (c === correctAnswer) {
                        if (quizFeedbackText) {
                            quizFeedbackText.textContent = "æ­£ç¢ºï¼ğŸ‘";
                            quizFeedbackText.className = "text-center font-bold mt-4 h-6 text-green-600 text-lg";
                        }
                        setTimeout(() => {
                            if (quizFeedbackText) quizFeedbackText.textContent = "";
                            onSuccess();
                        }, 1000);
                    } else {
                        if (quizFeedbackText) {
                            quizFeedbackText.textContent = "å†è©¦ä¸€æ¬¡... ğŸ¤”";
                            quizFeedbackText.className = "text-center font-bold mt-4 h-6 text-red-600 text-lg";
                        }
                    }
                };
                container.appendChild(btn);
            });
        }

        const finishQuizBtn = document.getElementById('finish-quiz-btn');
        if (finishQuizBtn) {
            finishQuizBtn.addEventListener('click', () => {
                hideModal(hcfQuizModal);
                
                // é¡¯ç¤ºã€Œé–‹å§‹æŒ‘æˆ°ã€æŒ‰éˆ•ï¼Œä¸¦å…è¨±è‡ªç”±è¦†æŸ¥
                if (startChallengeContainer) startChallengeContainer.classList.remove('hidden');
                
                if (farmerMessageEl) {
                    farmerMessageEl.innerHTML = 'ç¾åœ¨ä½ å¯ä»¥è‡ªç”±è¦†æŸ¥ï¼Œæº–å‚™å¥½å¾ŒæŒ‰ä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æŒ‘æˆ°ï¼';
                    farmerMessageEl.classList.add('bg-blue-100', 'border-blue-500');
                }
            });
        }

        // --- æŒ‘æˆ°è³½é‚è¼¯ ---

        function startChallengeMode() {
            isChallengeMode = true;
            currentChallengeIndex = 0;
            score = 0;
            timeLeft = 300; // 5åˆ†é˜
            gameOver = false;
            challengeHistory = [];
            
            if (challengeHeader) challengeHeader.classList.remove('hidden');
            if (startChallengeContainer) startChallengeContainer.classList.add('hidden'); // éš±è—é–‹å§‹æŒ‰éˆ•
            
            updateScoreDisplay();
            startChallengeTimer();
            loadChallengeLevel(currentChallengeIndex);
        }

        function loadChallengeLevel(index) {
            // æŒ‰ç…§æŒ‡å®šçš„é †åºå‡ºé¡Œ
            const levelConfig = challengeLevels[index];
            const w = levelConfig.w;
            const l = levelConfig.l;

            const displayIdx = index + 1;
            const levelData = {
                width: w,
                length: l,
                maxToolSize: Math.max(w, l),
                title: `ç¬¬${displayIdx}é¡Œï¼š${w}ç±³ (é—Š) Ã— ${l}ç±³ (é•·)`
            };
            
            if (levelIndicator) levelIndicator.textContent = `${displayIdx}`;
            
            // é‡ç½®ç”Ÿå‘½å€¼èˆ‡å¤±æ•—ç‹€æ…‹
            // ç¬¬8-10é¡Œ (index 7, 8, 9) çµ¦3å€‹å¿ƒï¼Œå…¶ä»–2å€‹
            if (index >= 7) {
                currentLevelLives = 3;
            } else {
                currentLevelLives = 2;
            }
            
            updateLivesDisplay();
            
            // é‡ç½®å·²æ‰¾åˆ°çš„å…¬å› æ•¸
            correctFactorsFound = [];
            
            loadLevelData(levelData);
        }

        function startChallengeTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endChallenge('æ™‚é–“åˆ°ï¼');
                    return;
                }
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const seconds = (timeLeft % 60).toString().padStart(2, '0');
                if (timerDisplay) timerDisplay.textContent = `${minutes}:${seconds}`;
                
                const progress = (300 - timeLeft) / 300 * 100;
                if (progressBar) progressBar.style.width = `${progress}%`;
            }, 1000);
        }

        function stopChallengeTimer() {
            clearInterval(timerInterval);
        }

        function handleChallengeSuccess(hcf) {
            // è¨˜éŒ„æ•¸æ“š
            challengeHistory.push({
                level: currentChallengeIndex + 1,
                title: `${currentFarm.width}x${currentFarm.length}`,
                commonFactors: getCommonFactors(currentFarm.width, currentFarm.length),
                hcf: hcf
            });

            score += 10; 
            updateScoreDisplay();
            
            if (levelCompleteModal) {
                levelCompleteModal.querySelector('p:nth-child(3)').textContent = `æœ€å¤§å…¬å› æ•¸æ˜¯ ${hcf}ç±³ã€‚+10 åˆ†ï¼`;
                showModal(levelCompleteModal);
            }
        }

        function handleWrongAnswer(clickedSize, isHCFSelection = false) {
            currentLevelLives--;
            updateLivesDisplay();
            
            lastErrorWasHCFSelection = isHCFSelection; // è¨˜éŒ„éŒ¯èª¤é¡å‹

            let msg = "";
            if (isHCFSelection) {
                msg = "é€™ä¸æ˜¯æœ€å¤§çš„å…¬å› æ•¸ï¼";
            } else {
                msg = "é€™å€‹å°ºå¯¸ä¸èƒ½é‹ªæ»¿è€•åœ°ã€‚";
            }

            if (currentLevelLives > 0) {
                // é‚„æœ‰æ©Ÿæœƒï¼šé¡¯ç¤ºè­¦å‘Šï¼Œä¸ç½°æ™‚
                
                // 1. æ›´æ–°åº•éƒ¨è¾²å¤«è¨Šæ¯
                if (farmerMessageEl) {
                    farmerMessageEl.innerHTML = `${msg} é‚„å‰© <span class="font-bold text-red-600">${currentLevelLives}</span> æ¬¡æ©Ÿæœƒï¼`;
                    farmerMessageEl.classList.add('border-red-500');
                }

                // 2. æ›´æ–°å½ˆçª—å…§çš„æ–‡å­— (ä¿®å¾©å¯«æ­» "1æ¬¡" çš„å•é¡Œ)
                const warnText = document.getElementById('warn-chances-text');
                if (warnText) {
                    warnText.textContent = `é‚„å‰© ${currentLevelLives} æ¬¡æ©Ÿæœƒï¼`;
                }

                showModal(levelWarnModal);
            } else {
                // æ²’æ©Ÿæœƒäº†ï¼šæœ¬é—œå¤±æ•—ï¼Œç½°æ™‚
                currentLevelFails++;
                const penalty = 30 + (currentLevelFails - 1) * 10;
                timeLeft = Math.max(0, timeLeft - penalty);
                
                if (failPenaltyMsg) failPenaltyMsg.textContent = `æ‰£é™¤ ${penalty} ç§’ï¼`;
                showModal(levelFailModal);
            }
        }

        if (dismissWarnBtn) {
            dismissWarnBtn.addEventListener('click', () => {
                 hideModal(levelWarnModal);
                 // å¦‚æœå‰›æ‰æ˜¯é¸éŒ¯ HCFï¼Œé‡æ–°é¡¯ç¤ºé¸æ“‡è¦–çª—
                 if (lastErrorWasHCFSelection) {
                     showModal(challengeHcfSelectModal);
                 }
            });
        }

        if (dismissFailBtn) {
            dismissFailBtn.addEventListener('click', () => {
                hideModal(levelFailModal);
                
                // æœ¬é—œå¤±æ•—å¾Œï¼Œé‡æ–°é–‹å§‹æœ¬é—œ
                // æ ¹æ“šç•¶å‰é—œå¡é‡ç½®ç”Ÿå‘½å€¼
                const isManual = (currentChallengeIndex >= 7);
                currentLevelLives = isManual ? 3 : 2;
                
                updateLivesDisplay();
                lastErrorWasHCFSelection = false; // é‡ç½®
                
                // æ¢å¾©è¦–è¦ºæ•ˆæœ
                if (farmGridContainer) farmGridContainer.innerHTML = '';
                // é‡ç½®å·²æ‰¾åˆ°çš„
                correctFactorsFound = [];
                testedSizes = {};
                // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
                if (toolBoxEl) {
                    const allBtns = toolBoxEl.querySelectorAll('.tool-btn');
                    allBtns.forEach(btn => btn.classList.remove('tested'));
                }
                // é‡ç½®è¡¨æ ¼ (åœ¨æŒ‘æˆ°æ¨¡å¼é€™å¾ˆé‡è¦)
                if (resultsBodyEl) resultsBodyEl.innerHTML = '';
                
                // é‡ç½®æ‰‹å‹•è¼¸å…¥æ­·å²
                if (manualHistory) manualHistory.innerHTML = '';
                
                if (timeLeft <= 0) endChallenge("æ™‚é–“è€—ç›¡ï¼");
            });
        }

        if (nextChallengeBtn) {
            nextChallengeBtn.addEventListener('click', () => {
                hideModal(levelCompleteModal);
                
                currentChallengeIndex++;
                if (currentChallengeIndex >= challengeLevels.length) {
                    endChallenge('æ­å–œå®Œæˆæ‰€æœ‰æŒ‘æˆ°ï¼');
                } else {
                    loadChallengeLevel(currentChallengeIndex);
                }
            });
        }

        function updateScoreDisplay() {
            if (scoreDisplay) scoreDisplay.textContent = score;
        }

        function endChallenge(reason) {
            stopChallengeTimer();
            gameOver = true;
            
            if (endReasonEl) endReasonEl.textContent = reason;
            if (finalScoreEl) finalScoreEl.textContent = score;
            if (finalSolvedEl) finalSolvedEl.textContent = challengeHistory.length;
            
            // å¡«å……æ­·å²è¡¨æ ¼
            if (historyTableBody) {
                historyTableBody.innerHTML = challengeHistory.map(item => `
                    <tr>
                        <td class="px-3 py-2 text-center font-bold text-gray-700">${item.level}</td>
                        <td class="px-3 py-2 font-mono">${item.title}</td>
                        <td class="px-3 py-2 text-xs text-gray-500 break-words max-w-[150px]">${item.commonFactors.join(', ')}</td>
                        <td class="px-3 py-2 text-center font-bold text-green-600">${item.hcf}</td>
                    </tr>
                `).join('');
            }
            
            showModal(challengeEndModal);
        }
        
        window.onload = function() {
            initGame();
        };
    </script>
</body>
</html>