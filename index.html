<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å°è¾²å¤«è€•ç¨®æ¨‚ (æŒ‘æˆ°ç‰ˆ) ğŸšœ</title>
    <!-- è¼‰å…¥ Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            overscroll-behavior: none; /* é˜²æ­¢ "pull-to-refresh" */
        }
        /* è€•åœ°å®¹å™¨ */
        #farm-grid-container {
            display: grid;
            border: 4px solid #8B4513; /* åœŸå£¤é¡è‰² */
            background-color: #fcf8e3; /* æ·ºé»ƒè‰²ä»£è¡¨æ³¥åœŸ */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            overflow: hidden; /* é˜²æ­¢ç£šå¡Šæº¢å‡º */
            position: relative; /* ç”¨æ–¼å®šä½çµæœæ–‡å­— */
            /* 1. æ”¹ç‚ºæµé«”å¯¬åº¦ */
            width: 100%; 
            max-width: 450px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            margin: 0 auto; /* å±…ä¸­ */
            /* 2. ä½¿ç”¨ aspect-ratio ä¿æŒæ¯”ä¾‹ */
            aspect-ratio: var(--aspect-ratio-val, 1 / 1);
        }

        /* é‹ªç£šæ•ˆæœ (å…±åŒæ¨£å¼) */
        .tile-base {
            position: absolute;
            box-sizing: border-box; /* ç¢ºä¿ border ä¸æœƒå¢åŠ å°ºå¯¸ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem; /* æ”¾å¤§ Emoji */
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            animation: tile-fade-in 0.3s ease-out forwards;
            transform-origin: center;
            line-height: 1;
            /* 3. å°ºå¯¸æ”¹ç‚º % - é‚Šç•Œ (2px) */
            width: calc(var(--tile-width, 10%) - 1px);
            height: calc(var(--tile-height, 10%) - 1px);
            left: calc(var(--tile-x, 0%) + 1px);
            top: calc(var(--tile-y, 0%) + 1px);
        }

        /* é‹ªç£šæ•ˆæœ */
        .plant-tile {
            background-color: #22c55e; /* green-500 */
            border: 1px solid #16a34a; /* darker green */
            opacity: 0.85;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 10;
            color: white;
        }
        .gap-tile {
            background-color: #ef4444; /* red-500 */
            border: 1px dashed white;
            opacity: 0.7;
            z-index: 10;
            color: white;
        }
        
        @keyframes tile-fade-in {
            0% { opacity: 0; transform: scale(0.7); }
            /* 4. ä¿®æ­£å‹•ç•«çµæŸæ™‚çš„é€æ˜åº¦ */
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* .gap-tile opacity æ‡‰è¨­ç‚º 1 (å›  tile-base å·²è¨­) */
        .gap-tile { opacity: 0.7; }
        .plant-tile { opacity: 0.85; }


        /* å·¥å…·ç®±æŒ‰éˆ• */
        .tool-btn {
            transition: all 0.2s ease;
        }
        /* å·²æ¸¬è©¦éçš„æŒ‰éˆ• */
        .tool-btn.tested {
            background-color: #6b7280; /* gray-500 */
            color: white;
            opacity: 0.7;
            cursor: not-allowed;
        }
        /* 5. éŠæˆ²çµæŸæ™‚ç¦ç”¨æŒ‰éˆ• */
        .tool-btn:disabled {
            background-color: #9ca3af; /* gray-400 */
            color: #e5e7eb; /* gray-200 */
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(0.95);
        }

        /* æ„›å¿ƒ (ç”Ÿå‘½å€¼) */
        #lives-display {
            font-size: 1.75rem; /* æ”¾å¤§æ„›å¿ƒ */
            letter-spacing: 0.2em;
        }
        
        /* å½ˆçª—å‹•ç•« */
        .modal-content {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: scale(0.95);
            opacity: 0;
        }
        .modal-content.show {
            transform: scale(1);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-yellow-50 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-5xl mx-auto bg-white rounded-2xl shadow-2xl p-6 md:p-8">
        
        <!-- æ¨™é¡Œ --><header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-yellow-900">å°å°è¾²å¤«è€•ç¨®æ¨‚ ğŸšœ</h1>
            <!-- æ›´æ–°æè¿° -->
            <p class="text-lg text-gray-600 mt-2">å¹«åŠ©è¾²å¤«ä»¥ä¸æµªè²»åœŸåœ°çš„æ–¹æ³•ç¨®è¾²ä½œç‰©</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-6">

            <!-- å·¦å´ï¼šè€•åœ°æ¨¡æ“¬å€ --><main class="w-full lg:w-3/5 border-4 border-yellow-800 bg-yellow-100 rounded-lg p-4">
                <!-- é—œå¡æ¨™é¡Œ --><h2 id="level-title" class="text-xl font-bold text-center text-yellow-800 mb-2"></h2>
                
                <!-- ç”Ÿå‘½å€¼é¡¯ç¤º -->
                <div id="lives-display" class="text-center text-3xl mb-3" aria-label="å‰©é¤˜æ©Ÿæœƒ">
                    <!-- JS æœƒå¡«å…¥æ„›å¿ƒ -->
                </div>

                <!-- è¾²å¤«æç¤º --><div id="farmer-message" class="bg-white border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg shadow mb-4 min-h-[60px]">
                    è«‹å–ºå³é‚Šå˜…ã€Œè¾²ä½œç‰©å·¥å…·ç®±ã€æ€ä¸€æ¬¾æ­£æ–¹å½¢è¾²ä½œç‰©è©¦ä¸‹å•¦ï¼
                </div>

                <!-- è€•åœ°æ¨¡æ“¬å€åŸŸ --><div class="relative w-full max-w-xl mx-auto mb-6 pt-10 pl-10"> <!-- å¢åŠ  padding æ”¾ç½®æ¨™ç±¤ -->
                    
                    <!-- é—Šåº¦æ¨™ç±¤ -->
                    <div id="farm-label-width" class="absolute top-2 left-1/2 -translate-x-1/2 text-center text-sm font-bold text-yellow-900 bg-yellow-200 px-2 py-0.5 rounded">
                        <!-- JS æœƒå¡«å…¥é—Šåº¦ -->
                    </div>
                    
                    <!-- é•·åº¦æ¨™ç±¤ (å·²ä¿®æ­£) -->
                    <div id="farm-label-length" class="absolute left-1 top-1/2 -translate-y-1/2 text-sm font-bold text-yellow-900 bg-yellow-200 px-2 py-0.5 rounded" style="writing-mode: vertical-rl; transform: translateY(-50%);">
                        <!-- JS æœƒå¡«å…¥é•·åº¦ -->
                    </div>
                    
                    <!-- 6. å®¹å™¨å¯¬åº¦é™åˆ¶ç§»è‡³ #farm-grid-container -->
                    <div id="farm-grid-container" class="relative">
                        <!-- è¾²ä½œç‰©å–®å…ƒæ ¼æœƒç”± JS ç”Ÿæˆ -->
                    </div>
                    
                    <!-- é‹ªè¨­çµæœæ–‡å­— --><div id="overlay-results" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-20 p-10">
                        <div id="width-result-text" class="text-lg font-bold bg-white/80 p-2 rounded shadow mb-2 hidden"></div>
                        <div id="length-result-text" class="text-lg font-bold bg-white/80 p-2 rounded shadow hidden"></div>
                    </div>
                </div>

                <!-- æŒ‰éˆ•å€åŸŸ -->
                <div id="button-container" class="mt-6 space-y-4">
                    <!-- ç¸½çµæŒ‰éˆ• (é è¨­éš±è—) --><button id="summary-button" class="hidden w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-blue-700 transition duration-300">
                        æŸ¥çœ‹æœ¬é—œç¸½çµï¼
                    </button>
                    <!-- ä¸‹ä¸€é—œæŒ‰éˆ• (é è¨­éš±è—) --><button id="next-level-button" class="hidden w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-green-700 transition duration-300">
                        æŒ‘æˆ°ä¸‹ä¸€é—œï¼
                    </button>
                    <!-- é‡æ–°æŒ‘æˆ°æŒ‰éˆ• (é è¨­éš±è—) --><button id="retry-button" class="hidden w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-red-700 transition duration-300">
                        é‡æ–°æŒ‘æˆ°æœ¬é—œ
                    </button>
                </div>

            </main>

            <!-- å³å´ï¼šå·¥å…·ç®± & çµæœ --><aside class="w-full lg:w-2/5">
                <!-- è¾²ä½œç‰©å·¥å…·ç®± --><div class="bg-gray-100 rounded-lg p-4 shadow-md">
                    <h3 class="text-lg font-bold text-gray-800 text-center mb-3">ğŸŒ¼ è¾²ä½œç‰©å·¥å…·ç®± ğŸŒ¼</h3>
                    <p class="text-sm text-center text-gray-600 mb-4">(è«‹æ¸¬è©¦æ‰€æœ‰å°ºå¯¸)</p>
                    <div id="toolbox" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-3 gap-3">
                        <!-- JS æœƒå–ºå‘¢åº¦åŠ å…¥æŒ‰éˆ• --></div>
                </div>

                <!-- æ¸¬è©¦çµæœ --><div class="bg-blue-50 rounded-lg p-4 mt-6 shadow-md">
                    <h3 class="text-lg font-bold text-blue-800 text-center mb-4">ğŸ“‹ æ¸¬è©¦çµæœ ğŸ“‹</h3>
                    <table id="results-table" class="w-full text-center">
                        <thead>
                            <tr class="border-b-2 border-blue-200">
                                <th class="py-2">è¾²ä½œç‰©é‚Šé•·</th>
                                <th class="py-2">é—Šåº¦çš„å› æ•¸ï¼Ÿ</th>
                                <th class="py-2">é•·åº¦çš„å› æ•¸ï¼Ÿ</th>
                                <th class="py-2"><strong>é‹ªæ»¿?</strong></th>
                            </tr>
                        </thead>
                        <tbody id="results-body" class="text-gray-700">
                            <!-- JS æœƒå–ºå‘¢åº¦åŠ å…¥çµæœ --></tbody>
                    </table>
                </div>
            </aside>

        </div>
    </div>
    
    <!-- ç¸½çµå½ˆçª— (Modal) --><div id="summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-lg p-8 max-w-lg w-full">
            <h2 id="summary-title" class="text-2xl font-bold text-blue-800 mb-4">æœ¬é—œç¸½çµ ğŸ’¡</h2>
            <div id="summary-text" class="text-gray-700 space-y-3">
                <!-- JS æœƒå¡«å…¥ç¸½çµå…§å®¹ --></div>
            <button id="close-modal-button" class="mt-6 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                æˆ‘æ˜ç™½å–‡ï¼
            </button>
        </div>
    </div>
    
    <!-- 7. æ–°å¢ï¼šå°æ¸¬é©—å½ˆçª— (Modal) -->
    <div id="quiz-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-40">
        <div class="modal-content bg-white rounded-lg p-8 max-w-md w-full">
            <h2 class="text-xl font-bold text-gray-800 mb-4">éå¸¸å¥½ï¼</h2>
            <p id="quiz-question" class="text-lg text-gray-700 mb-6">ä½ å­¸æœƒäº†èƒ½é‹ªæ»¿è€•åœ°çš„è¾²ä½œç‰©é‚Šé•·ï¼Œæ˜¯è€•åœ°é•·åº¦å’Œé—Šåº¦çš„...ï¼Ÿ</p>
            <div class="space-y-3">
                <button id="quiz-btn-factor" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-green-600 transition duration-300">
                    å…¬å› æ•¸
                </button>
                <button id="quiz-btn-multiple" class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-yellow-600 transition duration-300">
                    å…¬å€æ•¸
                </button>
            </div>
            <p id="quiz-feedback" class="text-center font-bold mt-4 h-6"></p>
        </div>
    </div>


    <script>
        // 8. éŠæˆ²è¨­å®šï¼šæ”¹ç‚ºå–®ä¸€é—œå¡
        const levels = [
            {
                level: 1,
                width: 12, // è€•åœ°é—Šåº¦
                length: 18, // è€•åœ°é•·åº¦
                maxToolSize: 12, // æœ€å¤§æ¸¬è©¦å°ºå¯¸
                title: "è€•åœ°ï¼š 12ç±³ (é—Š) Ã— 18ç±³ (é•·)"
            }
            // æš«æ™‚ç§»é™¤ HCF é—œå¡ï¼Œå°ˆæ³¨ç•¶å‰è¨­å®š
            // { ... } 
        ];

        let currentLevelIndex = 0;
        let currentFarm;
        let testedSizes = {}; // ç”¨æ–¼è¿½è¹¤å·²æ¸¬è©¦çš„å°ºå¯¸
        let lives = 3; // 9. ç”Ÿå‘½å€¼
        let totalCorrectFactors = 0; // è©²é—œå¡æ­£ç¢ºç­”æ¡ˆç¸½æ•¸
        let correctFactorsFound = []; // å·²æ‰¾åˆ°çš„æ­£ç¢ºç­”æ¡ˆ
        let gameOver = false; // éŠæˆ²çµæŸæ¨™è¨˜
        
        // 10. å­¸ç”Ÿè¡¨ç¾è¿½è¹¤
        let currentRetryCount = 0; // ç•¶å‰é—œå¡å˜—è©¦æ¬¡æ•¸ (å¾ 0 é–‹å§‹)
        let performanceData = []; // å„²å­˜æ‰€æœ‰å˜—è©¦ç´€éŒ„
        let currentErrorsMade = 0; // ç•¶å‰å˜—è©¦çŠ¯éŒ¯æ¬¡æ•¸
        
        // 11. å„²å­˜æœ€å¾Œæ¸¬è©¦å°ºå¯¸ (ç”¨æ–¼ resize)
        let lastTestedSize = null;

        // DOM å…ƒç´ 
        const farmGridContainer = document.getElementById('farm-grid-container');
        const farmerMessageEl = document.getElementById('farmer-message');
        const toolBoxEl = document.getElementById('toolbox');
        const resultsBodyEl = document.getElementById('results-body');
        const summaryButton = document.getElementById('summary-button');
        const nextLevelButton = document.getElementById('next-level-button');
        const retryButton = document.getElementById('retry-button'); // 12. é‡è©¦æŒ‰éˆ•
        const levelTitleEl = document.getElementById('level-title');
        const livesDisplay = document.getElementById('lives-display'); // 13. æ„›å¿ƒé¡¯ç¤º
        
        // è¾²ç”°çµæœé¡¯ç¤ºå…ƒç´ 
        const widthResultText = document.getElementById('width-result-text');
        const lengthResultText = document.getElementById('length-result-text');
        const overlayResults = document.getElementById('overlay-results');
        
        // è¾²ç”°æ¨™ç±¤
        const farmLabelWidth = document.getElementById('farm-label-width');
        const farmLabelLength = document.getElementById('farm-label-length');
        
        // Modal å…ƒç´ 
        const summaryModal = document.getElementById('summary-modal');
        const summaryTitle = document.getElementById('summary-title');
        const summaryText = document.getElementById('summary-text');
        const closeModalButton = document.getElementById('close-modal-button');

        // 14. å°æ¸¬é©— Modal å…ƒç´ 
        const quizModal = document.getElementById('quiz-modal');
        const quizBtnFactor = document.getElementById('quiz-btn-factor');
        const quizBtnMultiple = document.getElementById('quiz-btn-multiple');
        const quizFeedback = document.getElementById('quiz-feedback');

        // --- æ ¸å¿ƒè¼”åŠ©å‡½æ•¸ ---

        // 15. è¨ˆç®—å› æ•¸ (æ›´æ•´æ½”)
        function getFactors(num) {
            const factors = [];
            for (let i = 1; i <= num; i++) {
                if (num % i === 0) {
                    factors.push(i);
                }
            }
            return factors;
        }

        // 16. è¨ˆç®—å…¬å› æ•¸ (ç”¨æ–¼è¨ˆç®—ç­”æ¡ˆç¸½æ•¸)
        function getCommonFactors(num1, num2) {
            const factors1 = getFactors(num1);
            const factors2 = getFactors(num2);
            return factors1.filter(f => factors2.includes(f));
        }
        
        // 17. é¡¯ç¤º Modal å‹•ç•« (å…±ç”¨)
        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
            const content = modalElement.querySelector('.modal-content');
            if (content) {
                // å»¶é²ä»¥è§¸ç™¼ CSS transition
                setTimeout(() => content.classList.add('show'), 10);
            }
        }

        // 18. éš±è— Modal å‹•ç•« (å…±ç”¨)
        function hideModal(modalElement) {
            const content = modalElement.querySelector('.modal-content');
            if (content) {
                content.classList.remove('show');
                setTimeout(() => modalElement.classList.add('hidden'), 300);
            } else {
                modalElement.classList.add('hidden');
            }
        }

        // --- éŠæˆ²æµç¨‹å‡½æ•¸ ---

        // å•Ÿå‹•éŠæˆ²
        function initGame() {
            currentLevelIndex = 0;
            currentRetryCount = 0; // é¦–æ¬¡è¼‰å…¥
            performanceData = []; // æ¸…ç©ºæ•¸æ“š
            loadLevel(currentLevelIndex);
        }
        
        // è¼‰å…¥é—œå¡
        function loadLevel(levelIndex) {
            currentFarm = levels[levelIndex];
            testedSizes = {}; // é‡è¨­å·²æ¸¬è©¦å°ºå¯¸
            gameOver = false;
            lives = 3; // é‡è¨­ç”Ÿå‘½å€¼
            correctFactorsFound = []; // é‡è¨­å·²æ‰¾åˆ°ç­”æ¡ˆ
            lastTestedSize = null; // é‡è¨­æœ€å¾Œæ¸¬è©¦å°ºå¯¸
            currentErrorsMade = 0; // é‡è¨­éŒ¯èª¤æ¬¡æ•¸
            
            // 19. è¨ˆç®—æœ¬é—œæ­£ç¢ºç­”æ¡ˆç¸½æ•¸
            totalCorrectFactors = getCommonFactors(currentFarm.width, currentFarm.length)
                                    .filter(f => f <= currentFarm.maxToolSize)
                                    .length;

            // æ›´æ–°æ¨™é¡Œ
            levelTitleEl.textContent = currentFarm.title;
            updateLivesDisplay(); // æ›´æ–°æ„›å¿ƒ
            
            // æ›´æ–°è¾²ç”°æ¨™ç±¤
            farmLabelWidth.textContent = `é—Šåº¦: ${currentFarm.width}ç±³`;
            farmLabelLength.textContent = `é•·åº¦: ${currentFarm.length}ç±³`;
            
            // 20. è¨­å®šè€•åœ°æ¯”ä¾‹
            farmGridContainer.style.setProperty('--aspect-ratio-val', `${currentFarm.width} / ${currentFarm.length}`);
            
            // æ¸…ç©ºè€•åœ°
            farmGridContainer.innerHTML = '';

            // é‡è¨­è¾²å¤«è¨Šæ¯
            farmerMessageEl.innerHTML = 'è«‹å–ºå³é‚Šå˜…ã€Œè¾²ä½œç‰©å·¥å…·ç®±ã€æ€ä¸€æ¬¾æ­£æ–¹å½¢è¾²ä½œç‰©è©¦ä¸‹å•¦ï¼';
            farmerMessageEl.className = 'bg-white border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg shadow mb-4 min-h-[60px]';

            // éš±è—æŒ‰éˆ•
            summaryButton.classList.add('hidden');
            nextLevelButton.classList.add('hidden');
            retryButton.classList.add('hidden');
            
            // éš±è—çµæœæ–‡å­—
            widthResultText.classList.add('hidden');
            lengthResultText.classList.add('hidden');
            
            // ç”¢ç”Ÿå·¥å…·ç®±æŒ‰éˆ•
            toolBoxEl.innerHTML = '';
            for (let i = 1; i <= currentFarm.maxToolSize; i++) {
                const button = document.createElement('button');
                button.textContent = `${i}ç±³`;
                button.dataset.size = i;
                button.className = 'tool-btn w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-3 px-2 rounded-lg shadow-md';
                // 21. ç°¡åŒ–é»æ“Šäº‹ä»¶
                button.addEventListener('click', () => testSize(i));
                toolBoxEl.appendChild(button);
            }
            
            // ç”¢ç”Ÿçµæœè¡¨æ ¼
            resultsBodyEl.innerHTML = '';
            for (let i = 1; i <= currentFarm.maxToolSize; i++) {
                const row = document.createElement('tr');
                row.id = `result-row-${i}`;
                row.className = 'border-b border-blue-100';
                row.innerHTML = `
                    <td class="py-2 font-bold">${i}ç±³</td>
                    <td id="width-fit-${i}" class="py-2 text-gray-400">?</td>
                    <td id="length-fit-${i}" class="py-2 text-gray-400">?</td>
                    <td id="all-fit-${i}" class="py-2 text-gray-400">?</td>
                `;
                resultsBodyEl.appendChild(row);
            }
        }

        // æ¸¬è©¦å°ºå¯¸ (æ ¸å¿ƒé‚è¼¯)
        function testSize(size) {
            if (gameOver || testedSizes[size]) return; // éŠæˆ²çµæŸæˆ–å·²æ¸¬è©¦é
            
            lastTestedSize = size; // å„²å­˜æœ€å¾Œæ¸¬è©¦å°ºå¯¸
            
            // è¨ˆç®—èƒ½å¦é‹ªæ»¿
            const widthRemainder = currentFarm.width % size;
            const lengthRemainder = currentFarm.length % size;
            const fitsWidth = widthRemainder === 0;
            const fitsLength = lengthRemainder === 0;
            const fitsAll = fitsWidth && fitsLength;

            // æ¨™è¨˜æŒ‰éˆ•ç‚ºå·²æ¸¬è©¦
            const button = toolBoxEl.querySelector(`[data-size="${size}"]`);
            if(button) {
                button.classList.add('tested');
            }
            testedSizes[size] = true;

            // 22. åŸ·è¡Œè¦–è¦ºåŒ–
            visualizeTest(size, fitsWidth, fitsLength, widthRemainder, lengthRemainder);
            
            // æ›´æ–°çµæœè¡¨æ ¼
            updateTable(size, fitsWidth, fitsLength, fitsAll);
            
            // æ›´æ–°è¾²å¤«è¨Šæ¯
            updateFarmerMessage(size, fitsWidth, fitsLength, fitsAll);
            
            // 23. æª¢æŸ¥éŠæˆ²ç‹€æ…‹ (å‹åˆ©/å¤±æ•—)
            if (fitsAll) {
                // ç­”å•±
                if (!correctFactorsFound.includes(size)) {
                    correctFactorsFound.push(size);
                }
                if (correctFactorsFound.length === totalCorrectFactors) {
                    winGame();
                }
            } else {
                // ç­”éŒ¯
                lives--;
                currentErrorsMade++; // è¨˜éŒ„éŒ¯èª¤
                updateLivesDisplay();
                if (lives === 0) {
                    loseGame();
                }
            }
        }
        
        // 24. è¦–è¦ºåŒ– (æŠ½é›¢)
        function visualizeTest(size, fitsWidth, fitsLength, widthRemainder, lengthRemainder) {
            // å…ˆæ¸…é™¤ä¹‹å‰çš„æ‰€æœ‰ç£šå¡Šå’Œçµæœ
            farmGridContainer.innerHTML = '';
            widthResultText.classList.add('hidden');
            lengthResultText.classList.add('hidden');
            
            if (size === null) return; // å¦‚æœæ²’æœ‰æ¸¬è©¦å°ºå¯¸ (ä¾‹å¦‚ resize)

            // 25. å°ºå¯¸æ”¹ç‚º %
            const tileWidthPerc = (size / currentFarm.width) * 100;
            const tileLengthPerc = (size / currentFarm.length) * 100;
            const gapWidthPerc = (widthRemainder / currentFarm.width) * 100;
            const gapLengthPerc = (lengthRemainder / currentFarm.length) * 100;

            const numTilesX = Math.floor(currentFarm.width / size);
            const numTilesY = Math.floor(currentFarm.length / size);

            let delay = 0;

            // é‹ªè¨­ä¸»è¦è¾²ä½œç‰©
            for (let y = 0; y < numTilesY; y++) {
                for (let x = 0; x < numTilesX; x++) {
                    createPlantTile(
                        x * tileWidthPerc, 
                        y * tileLengthPerc, 
                        tileWidthPerc, 
                        tileLengthPerc, 
                        true, // isFit
                        delay,
                        'ğŸŒ±'
                    );
                    delay += 5;
                }
            }

            // è™•ç†å‰©é¤˜ç©ºé–“ (Gap Tiles)
            if (!fitsWidth) { // é—Šåº¦æœ‰å‰©
                for (let y = 0; y < numTilesY; y++) {
                    createPlantTile(numTilesX * tileWidthPerc, y * tileLengthPerc, gapWidthPerc, tileLengthPerc, false, delay, 'ğŸš«');
                    delay += 5;
                }
            }
            
            if (!fitsLength) { // é•·åº¦æœ‰å‰©
                for (let x = 0; x < numTilesX; x++) {
                    createPlantTile(x * tileWidthPerc, numTilesY * tileLengthPerc, tileWidthPerc, gapLengthPerc, false, delay, 'ğŸš«');
                    delay += 5;
                }
            }
            
            if (!fitsWidth && !fitsLength) { // è§’è½æœ‰å‰©
                createPlantTile(numTilesX * tileWidthPerc, numTilesY * tileLengthPerc, gapWidthPerc, gapLengthPerc, false, delay, 'ğŸš«');
                delay += 5;
            }


            // æ›´æ–°é—Šåº¦çµæœæ–‡å­— (å»¶é²é¡¯ç¤º)
            setTimeout(() => {
                widthResultText.classList.remove('hidden');
                if (fitsWidth) {
                    widthResultText.textContent = `âœ… é—Šåº¦ (${currentFarm.width}ç±³) å•±å•±å¥½ï¼`;
                    widthResultText.className = 'text-lg font-bold bg-green-100/90 p-2 rounded shadow text-green-700';
                } else {
                    widthResultText.textContent = `âŒ é—Šåº¦ (${currentFarm.width}ç±³) å‰©ä½ ${widthRemainder}ç±³ï¼`;
                    widthResultText.className = 'text-lg font-bold bg-red-100/90 p-2 rounded shadow text-red-700';
                }
            }, delay + 100);

            // æ›´æ–°é•·åº¦çµæœæ–‡å­— (å»¶é²é¡¯ç¤º)
            setTimeout(() => {
                lengthResultText.classList.remove('hidden');
                if (fitsLength) {
                    lengthResultText.textContent = `âœ… é•·åº¦ (${currentFarm.length}ç±³) å•±å•±å¥½ï¼`;
                    lengthResultText.className = 'text-lg font-bold bg-green-100/90 p-2 rounded shadow text-green-700';
                } else {
                    lengthResultText.textContent = `âŒ é•·åº¦ (${currentFarm.length}ç±³) å‰©ä½ ${lengthRemainder}ç±³ï¼`;
                    lengthResultText.className = 'text-lg font-bold bg-red-100/90 p-2 rounded shadow text-red-700';
                }
            }, delay + 200);
        }

        // å‰µå»ºæ¤ç‰©ç£šå¡Šæˆ–ç©ºä½ç£šå¡Š
        function createPlantTile(xPerc, yPerc, wPerc, hPerc, isFit, delay, emoji) {
            const tile = document.createElement('div');
            // 26. åˆä½µ class
            tile.className = `tile-base ${isFit ? 'plant-tile' : 'gap-tile'}`;
            
            // 27. ä½¿ç”¨ CSS è®Šæ•¸è¨­å®šä½ç½®å’Œå¤§å°
            tile.style.setProperty('--tile-x', `${xPerc}%`);
            tile.style.setProperty('--tile-y', `${yPerc}%`);
            tile.style.setProperty('--tile-width', `${wPerc}%`);
            tile.style.setProperty('--tile-height', `${hPerc}%`);
            
            tile.style.animationDelay = `${delay}ms`;
            
            // 28. åªæœ‰åœ¨å¤§ç£šå¡Šæ™‚é¡¯ç¤º Emoji
            if (wPerc > 5 && hPerc > 5) {
                tile.textContent = emoji || '';
            }
            farmGridContainer.appendChild(tile);
        }
        
        // --- ä»‹é¢æ›´æ–°å‡½æ•¸ (UI) ---

        // æ›´æ–°ç”Ÿå‘½å€¼é¡¯ç¤º
        function updateLivesDisplay() {
            livesDisplay.innerHTML = 'â¤ï¸'.repeat(lives) + 'ğŸ–¤'.repeat(3 - lives);
        }

        // æ›´æ–°çµæœè¡¨æ ¼
        function updateTable(size, fitsWidth, fitsLength, fitsAll) {
            document.getElementById(`width-fit-${size}`).innerHTML = fitsWidth ? 'âœ…' : 'âŒ';
            document.getElementById(`width-fit-${size}`).className = fitsWidth ? 'text-green-600' : 'text-red-600';
            
            document.getElementById(`length-fit-${size}`).innerHTML = fitsLength ? 'âœ…' : 'âŒ';
            document.getElementById(`length-fit-${size}`).className = fitsLength ? 'text-green-600' : 'text-red-600';
            
            const allFitCell = document.getElementById(`all-fit-${size}`);
            allFitCell.innerHTML = fitsAll ? 'ğŸŒŸ <strong>é‹ªå¾—æ»¿</strong>' : 'ğŸ˜¥';
            allFitCell.className = fitsAll ? 'text-yellow-600 font-bold' : 'text-gray-500';
            
            document.getElementById(`result-row-${size}`).classList.add('bg-blue-100');
        }
        
        // æ›´æ–°è¾²å¤«è¨Šæ¯
        function updateFarmerMessage(size, fitsWidth, fitsLength, fitsAll) {
            let message = '';
            let a_class = '';
            
            if (fitsAll) {
                message = `ğŸŒŸ å¤ªå¥½å–‡ï¼ ${size}ç±³ å˜…è¾²ä½œç‰©å•±å•±å¥½ï¼é—Šåº¦åŒé•·åº¦éƒ½é‹ªå¾—æ»¿ï¼`;
                a_class = 'bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-lg shadow mb-4 min-h-[60px]';
            } else if (fitsWidth && !fitsLength) {
                message = `ğŸ¤” å·®å°‘å°‘... ${size}ç±³ å˜…ç£šå•±é—Šåº¦ï¼Œä½†ä¿‚é•·åº¦å””å•±ã€‚`;
                a_class = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg shadow mb-4 min-h-[60px]';
            } else if (!fitsWidth && fitsLength) {
                message = `ğŸ¤” å·®å°‘å°‘... ${size}ç±³ å˜…ç£šå•±é•·åº¦ï¼Œä½†ä¿‚é—Šåº¦å””å•±ã€‚`;
                a_class = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg shadow mb-4 min-h-[60px]';
            } else {
                message = `ğŸ˜¥ å“å‘€... ${size}ç±³ å˜…ç£šé—Šåº¦åŒé•·åº¦éƒ½å””å•±... (ä½ å¾—è¿” ${lives} æ¬¡æ©Ÿæœƒå–‡ï¼)`;
                a_class = 'bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg shadow mb-4 min-h-[60px]';
            }
            farmerMessageEl.innerHTML = message;
            farmerMessageEl.className = a_class;
        }

        // 29. ç¦ç”¨å·¥å…·ç®±
        function disableToolbox() {
            toolBoxEl.querySelectorAll('.tool-btn').forEach(btn => {
                btn.disabled = true;
                if (!btn.classList.contains('tested')) {
                    btn.classList.add('tested'); // æ¨™è¨˜æ‰€æœ‰æŒ‰éˆ•
                }
            });
        }
        
        // --- éŠæˆ²ç‹€æ…‹å‡½æ•¸ ---

        // 30. è¨˜éŒ„æ•¸æ“š (å…±ç”¨)
        function logPerformance(status) {
            const record = {
                level: currentFarm.level,
                attempt: currentRetryCount + 1, // å˜—è©¦æ¬¡æ•¸ (ç”± 1 é–‹å§‹)
                status: status, // 'win' or 'lose'
                errorsMade: currentErrorsMade,
                livesRemaining: lives
            };
            performanceData.push(record);
            
            // é¡¯ç¤ºå–º Console ä¿¾è€å¸«ç‡
            console.log("--- å­¸ç”Ÿè¡¨ç¾æ•¸æ“š (æœ¬é—œå¡) ---");
            console.table(performanceData);
        }

        // 31. éŠæˆ²å‹åˆ©
        function winGame() {
            gameOver = true;
            disableToolbox();
            logPerformance('win'); // è¨˜éŒ„å‹åˆ©

            // 32. é¡¯ç¤ºå‹åˆ©å˜—è©¦æ¬¡æ•¸
            let attemptText = `ä½ ç¸½å…±å˜—è©¦å’— ${currentRetryCount + 1} æ¬¡å…ˆæˆåŠŸéé—œã€‚`;
            if (currentRetryCount === 0) {
                attemptText = "ä½ ç¬¬ 1 æ¬¡å˜—è©¦å°±æˆåŠŸå–‡ï¼";
            }

            farmerMessageEl.innerHTML = `ğŸ† <strong>æŒ‘æˆ°æˆåŠŸï¼</strong> ${attemptText} ä½ æµåˆ°æ™’ ${totalCorrectFactors} æ¬¾å•±ç”¨å˜…è¾²ä½œç‰©ï¼`;
            farmerMessageEl.className = 'bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-lg shadow mb-4 min-h-[60px]';
            
            // 33. é¡¯ç¤ºå°æ¸¬é©—ï¼Œè€Œå””ä¿‚å³åˆ»é¡¯ç¤ºç¸½çµ
            setTimeout(() => showQuizModal(), 500); // å»¶é²åŠç§’å½ˆå‡ºæ¸¬é©—
        }

        // 34. éŠæˆ²å¤±æ•—
        function loseGame() {
            gameOver = true;
            disableToolbox();
            logPerformance('lose'); // è¨˜éŒ„å¤±æ•—
            
            farmerMessageEl.innerHTML = 'ğŸ˜¥ å“å‘€... 3æ¬¡æ©Ÿæœƒç”¨å®Œå–‡ã€‚å””å¥½ç°å¿ƒï¼Œå†è©¦ä¸€æ¬¡å•¦ï¼';
            farmerMessageEl.className = 'bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg shadow mb-4 min-h-[60px]';
            
            retryButton.classList.remove('hidden'); // é¡¯ç¤ºé‡è©¦æŒ‰éˆ•
        }

        // 35. é¡¯ç¤ºç¸½çµ
        function showSummary() {
            const { width, length, maxToolSize } = currentFarm;
            
            const factorsW = getFactors(width);
            const factorsL = getFactors(length);
            // 36. åªé¡¯ç¤º maxToolSize ä»¥å…§å˜…å…¬å› æ•¸
            const commonFactors = getCommonFactors(width, length).filter(f => f <= maxToolSize);

            summaryTitle.textContent = `ç¬¬ ${currentFarm.level} é—œç¸½çµ ğŸ’¡`;
            summaryText.innerHTML = `
                <p>åšå¾—å¥½ï¼ä½ ç™¼ç¾å’—ä¸€å€‹å¤§ç§˜å¯†ï¼</p>
                <p>æˆ‘å“‹å˜…è€•åœ°ä¿‚ <strong>${width}ç±³ Ã— ${length}ç±³</strong>ã€‚</p>
                <ul class="list-disc list-inside ml-2">
                    <li>${width}ç±³ (é—Š) å˜…å› æ•¸æœ‰ï¼š ${factorsW.join(', ')}</li>
                    <li>${length}ç±³ (é•·) å˜…å› æ•¸æœ‰ï¼š ${factorsL.join(', ')}</li>
                </ul>
                <p class="mt-3">è¦å°‡è¾²ä½œç‰©ã€Œé‹ªå¾—æ»¿ã€ï¼ˆå””æµªè²»åœŸåœ°ï¼‰ï¼Œè¾²ä½œç‰©å˜…é‚Šé•·å¿…é ˆï¼š</p>
                <p class="text-center font-bold text-lg my-2">
                    <span class="text-green-600">âœ… ä¿‚é—Šåº¦ (${width}) å˜…å› æ•¸</span> <br/>
                    <span class="text-gray-600">+</span> <br/>
                    <span class="text-green-600">âœ… ä¿‚é•·åº¦ (${length}) å˜…å› æ•¸</span>
                </p>
                <p>å³ä¿‚è©±ï¼Œé‚Šé•·å¿…é ˆåŒæ™‚ä¿‚ ${width} <strong>åŒ</strong> ${length} å˜…å› æ•¸ï¼</p>
                <p class="text-xl font-bold text-center text-blue-700 mt-2">
                    æˆ‘å“‹å«å‘¢å•²æ•¸åš ã€Œå…¬å› æ•¸ã€ï¼
                </p>
                <p>å‘¢å¡Šç”°å˜…å…¬å› æ•¸ï¼ˆ${maxToolSize}ç±³å…§ï¼‰ä¿‚ï¼š <strong>${commonFactors.join(', ')} ç±³</strong>ã€‚åªæœ‰å‘¢å¹¾å€‹å°ºå¯¸å˜…è¾²ä½œç‰©å…ˆå¯ä»¥é‹ªå¾—æ»¿ï¼</p>
            `;
            
            // é¡¯ç¤ºå½ˆçª—
            showModal(summaryModal);
            
            // é¡¯ç¤ºä¸‹ä¸€é—œæŒ‰éˆ• (å¦‚æœæœ‰çš„è©±)
            if (currentLevelIndex < levels.length - 1) {
                nextLevelButton.classList.remove('hidden');
            }
        }
        
        // --- äº‹ä»¶ç¶å®š (Event Listeners) ---

        // 37. é¡¯ç¤º/éš±è—ç¸½çµ Modal
        summaryButton.addEventListener('click', showSummary);
        closeModalButton.addEventListener('click', () => hideModal(summaryModal));
        
        // 38. è™•ç†é‡è©¦
        function handleRetryClick() {
            currentRetryCount++; // å¢åŠ å˜—è©¦æ¬¡æ•¸
            loadLevel(currentLevelIndex);
        }
        retryButton.addEventListener('click', handleRetryClick);

        // 39. è™•ç†ä¸‹ä¸€é—œ
        function loadNextLevel() {
            if (currentLevelIndex < levels.length - 1) {
                currentLevelIndex++;
                currentRetryCount = 0; // æ–°é—œå¡ï¼Œé‡è¨­è¨ˆæ•¸
                loadLevel(currentLevelIndex);
                hideModal(summaryModal); // é—œé–‰å½ˆçª—
            }
        }
        nextLevelButton.addEventListener('click', loadNextLevel);
        
        // 40. è™•ç†è¦–çª—ç¸®æ”¾ (Resize) - æ”¹ç‚ºé‡ç¹ª
        function handleResize() {
            // åªéœ€é‡ç¹ªç£šå¡Šï¼Œä¸éœ€é‡è¨­éŠæˆ²
            if (lastTestedSize) {
                const size = lastTestedSize;
                const widthRemainder = currentFarm.width % size;
                const lengthRemainder = currentFarm.length % size;
                const fitsWidth = widthRemainder === 0;
                const fitsLength = lengthRemainder === 0;
                visualizeTest(size, fitsWidth, fitsLength, widthRemainder, lengthRemainder);
            } else {
                // å¦‚æœæœªæ¸¬è©¦éï¼Œåªæ¸…ç©º (ä¿æŒæ¯”ä¾‹)
                farmGridContainer.innerHTML = '';
            }
        }

        // 41. å°æ¸¬é©—ç›¸é—œ
        function showQuizModal() {
            quizFeedback.textContent = ''; // æ¸…ç©º feedback
            quizFeedback.className = 'text-center font-bold mt-4 h-6'; // é‡è¨­ class
            showModal(quizModal);
        }

        function hideQuizModal() {
            hideModal(quizModal);
        }

        function handleQuizChoice(isCorrect) {
            if (isCorrect) {
                quizFeedback.textContent = 'ç­”å•±å–‡ï¼ğŸŒŸ';
                quizFeedback.className = 'text-center font-bold mt-4 h-6 text-green-600';
                
                // ç¦ç”¨æŒ‰éˆ•
                quizBtnFactor.disabled = true;
                quizBtnMultiple.disabled = true;

                // ç­”å•±ï¼Œè‡ªå‹•é—œé–‰ä¸¦é¡¯ç¤ºç¸½çµ
                setTimeout(() => {
                    hideQuizModal();
                    
                    // é¡¯ç¤ºç¸½çµæŒ‰éˆ•
                    summaryButton.classList.remove('hidden');
                    
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹ (ä»¥ä¾¿ä¸‹æ¬¡æ¸¬é©—)
                    quizBtnFactor.disabled = false;
                    quizBtnMultiple.disabled = false;

                }, 1500); // 1.5ç§’å¾ŒåŸ·è¡Œ

            } else {
                quizFeedback.textContent = 'å””ä¿‚å‘¢å€‹å–”... å†è«—ä¸‹ï¼';
                quizFeedback.className = 'text-center font-bold mt-4 h-6 text-red-600';
            }
        }
        
        quizBtnFactor.addEventListener('click', () => handleQuizChoice(true)); // ç­”å•±
        quizBtnMultiple.addEventListener('click', () => handleQuizChoice(false)); // ç­”éŒ¯


        // éŠæˆ²åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initGame);
        // 42. ä½¿ç”¨ Debounce æ¸›å°‘ resize è§¸ç™¼æ¬¡æ•¸
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(handleResize, 100); // 100ms
        });
    </script>

</body>
</html>